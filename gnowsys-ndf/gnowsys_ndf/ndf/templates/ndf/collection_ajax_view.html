{% load ndf_tags %}
{% load i18n %}

{% block head %}

  <link href="/static/ndf/bower_components/jqtree/jqtree.css" rel="stylesheet"> 
  <script src="/static/ndf/bower_components/jqtree/tree.jquery.js"></script> <!-- checked -->
    
  <script type="text/javascript">
    $(document).ready(function() {

      // Funtion for loading tree for showing collection list left side panel
      doc();

      // Function for manipulating tree when user visits to page directly via browser url
      TreeTillNode();

    });

    function TreeTillNode () {
      // This gives the last hierarchy node id from browser url.
      var url = window.location.search.replace("?selected=", "")

      // Condition to check whether the tree has been loaded on the page completely or not before attempting any function on tree(such as 'getNodeById')
      if (url && $(".collection").not(".jqtree-loading").length > 0){
        var tree_build = $(".collection").not(".jqtree-loading");
        var node = tree_build.tree('getNodeById', url);
        tree_build.tree('selectNode', node);
        return;
      }
      
      // Javascript function to be used for checking objects in specific time of interval
      setTimeout(function(){
        // console.log($(".collection"))
        if(url && ($(".collection").length > 0)) { TreeTillNode() }
      }, 100 );
    
    }
    

    function doc(){

      var $tree = $('.collection');
      var arr = []

      $tree.tree({
        selectable: true
      });

      $tree.bind(
        'tree.open',
        function(e) {
            var node = e.node;
            var node_id = node.id;
            if (arr.indexOf(node_id) < 0){
              arr.push(node_id);  
            }

        }
      );

      $tree.bind(          
        'tree.click',
        function(event) {
            // The clicked node is 'event.node'
            var node = event.node;
            var node_type = node.node_type;
            // var breadcrumbs_list = "{{breadcrumbs_list}}"; 
            if (arr.length > 0){
              var nav_list = arr;  
            }
            else{
              arr.push(node.id);
              var nav_list = arr;
            }
            
            // alert(nav_list);

            $.ajax({
                type: "POST",
                url: "{% url 'collection_nav' group_id %}",
                datatype: "html",
                data:{
                  node_id: node.id,
                  curr_node:"{{node.pk}}",
                  nav: nav_list,
                  csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(data) {

                  if (node_type == "Page"){
                   window.history.pushState("", "", "/{{group_name_tag}}/page/{{node.pk}}"+"?selected="+node.id+"");
                  }
                  else if(node_type == "File"){
                    window.history.pushState("", "", "/{{group_name_tag}}/file/{{node.pk}}"+"?selected="+node.id+"");  
                  }
                  else if (node_type == "Term"){
                    window.history.pushState("", "", "/{{group_name_tag}}/term/{{node.pk}}"+"?selected="+node.id+"");
                  }
                  else if (node_type == "Topic"){
                    window.history.pushState("", "", "/{{group_name_tag}}/topic_details/{{node.pk}}"+"?selected="+node.id+"");
                  }

                  
                  // $("#content").css({"opacity":""})
                  $("#view_page").html(data);

                }


            });

            // $.ajax({
            //     type: "POST",
            //     url: "{#% url 'collection_view' group_id %#}",
            //     datatype: "html",
            //     data:{
            //       node_id: node.id,
            //       breadcrumbs_list: "{{breadcrumbs_list}}",
            //       csrfmiddlewaretoken: '{{ csrf_token }}'
            //     },
            //     success: function(data) {

            //       $("#view_collection").html(data);
            //     }
            // });
          
        }
      );
      
    }
    
  </script>

<style type="text/css">
  
  .collection {
    border: solid thin #ddd;
    margin-bottom: 1em;
    overflow: auto;
  }

  .collection > ul li:nth-child(odd) { background: #ddd; }
  
</style>  

{% endblock %}  

  <div>
    <div class="collection" data-url="{% url 'get_collection' group_id node.pk %}"></div>
  </div>

<script type="text/javascript">

  $(".current").click(function() {
    
    // $.ajax({
    //     type: "POST",
    //     url: "{#% url 'collection_view' group_id %#}",
    //     datatype: "html",
    //     data:{
    //       node_id: this.id,
    //       breadcrumbs_list: "{{breadcrumbs_list}}",
    //       csrfmiddlewaretoken: '{{ csrf_token }}'
    //     },
    //     success: function(data) {

    //       $("#view_collection").html(data);

    //     }
    // }); 

    // $.ajax({
    //     type: "POST",
    //     url: "{% url 'collection_nav' group_id %}",
    //     datatype: "html",
    //     data:{
    //       node_id: this.id,
    //       breadcrumbs_list: "{{breadcrumbs_list}}",
    //       csrfmiddlewaretoken: '{{ csrf_token }}'
    //     },
    //     success: function(data) {
    //       $("#view_page").html(data);
    //     }
    // }); 
   

  });

</script>

