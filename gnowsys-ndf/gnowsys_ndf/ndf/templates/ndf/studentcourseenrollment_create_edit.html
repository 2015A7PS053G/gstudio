{% extends "ndf/mis_base_create_edit.html" %}
{% load i18n %}
{% load ndf_tags %}
{% load pagination_tags %}

{% block head %}
  {{block.super}}

  <!-- DataTables -->
  <script src="/static/ndf/bower_components/DataTables/media/js/jquery.dataTables.js"></script>
  <script src="/static/ndf/bower_components/datatables-plugins/integration/foundation/dataTables.foundation.js"></script>
  <!-- DataTables CSS -->
  <link href="/static/ndf/bower_components/datatables-plugins/integration/foundation/dataTables.foundation.css" rel="stylesheet" type="text/css" />
{% endblock %}

{% block style %}
  {{block.super}}

  /* Resetting css-properties for fieldset (also legend, input) */
    /* fieldset (padding-bottom) */ 
    fieldset {
      padding: 0rem 1.25rem !important;
    }

    /* legend (background-color) */
    fieldset legend {
      background-color: transparent !important;
    }

    /* input (margin) */
    fieldset input {
      margin: 0 !important;
    }

  /* Setting css-properties for reveal-modal's label */
    div.reveal-modal > label {
      color: white;
      font-weight: bold;
      font-size: 1rem;
    }

    #announce-course.hide{
      display: none;
    }

    /* DataTables css-properties */
    .selected {
      background-color: skyblue !important;
    }
{% endblock %}

{% block body_content %} 
  <div id="alertModal" class="reveal-modal medium alert-box radius" data-reveal data-alert>
    <label id="alertModalLabel"></label>
    <a class="close-reveal-modal">&#215;</a>
  </div>

  <form data-abide enctype="multipart/form-data" id="form-edit-node" method="POST" action="">

    <header class="row" style="margin: 1rem 0 0 0 ;">
      <h2 class="small-12 columns">
        {% if node %}
        {% blocktrans with title_var=title node_name=node.name %} Editing {{title_var}}: {{node_name}} {% endblocktrans %}
        {% else %}
        {% trans title %}
        {% endif %}
      </h2>
    </header>

    <nav class="row" style="margin-top: 0.5rem;">
      <dl class="tabs small-12 columns" data-tab data-options="deep_linking:true">
        {% for tab_details in property_order_list %}
        <dd {% if forloop.counter == 1 %}class="active"{% endif %} title="STEP: Fill {{tab_details.0|lower}} details...">
          <a href="#panel_{{tab_details.0}}">
            {% blocktrans with tab_name=tab_details.0 %} {{tab_name}} {% endblocktrans %}
          </a>
        </dd>
        {% endfor %}
      </dl>
    </nav>

    {% csrf_token %}

    <div id="course-enrollment-edit-div" class="tabs-content" style="border-style: solid; border-width: 1.5px; border-color: #0eacb5; padding: 0px 5px;" >
      <div class="active content row" id="panel_{{property_order_list.0.0}}">
        <div class="row">
          <div class="small-2 columns">
            <label class="right inline">Enrollment Duration</label>
          </div>

          <div class="small-1 columns">
            <label for="{{property_order_list.0.1.1.name}}" class="right inline"> 
              {% trans "From" %}
            </label>
          </div>

          <div class="small-2 columns">
            {% html_widget groupid node.pk property_order_list.0.1.1 %}
          </div>

          <div class="small-1 columns">
            <label for="{{property_order_list.0.1.2.name}}" class="right inline"> 
              {% trans "To" %}
            </label>
          </div>

          <div class="small-2 columns end">
            {% html_widget groupid node.pk property_order_list.0.1.2 %}
          </div>

          <div class="small-1 columns">
            <label for="{{property_order_list.0.1.0.name}}" class="right inline"> 
              {% blocktrans with label_val=property_order_list.0.1.0.altnames %} {{label_val}} {% endblocktrans %}
            </label>
          </div>
          <div class="small-3 columns">
            {% html_widget groupid node.pk property_order_list.0.1.0 %}
          </div>
        </div>

        <div class="row">
          <div class="small-12 columns">
            <dl class="accordion" data-accordion>
              <dd class="accordion-navigation">
                <a href="#panel_announce_course">Select Announce Course(s)</a>
                <div id="panel_announce_course" class="content active">
                  <p>Please select course type.</p>
                  <table cellpadding="0" cellspacing="0" border="0" class="display" id="ac_table">
                  </table>
                </div>
              </dd>
            </dl>
          </div>
        </div>

        <div class="row">
          <div class="small-4 small-centered columns">
            <input type="button" class="small button expand" value="Create Enrollment">
          </div>
        </div>
      </div>
    </div>

  </form>
{% endblock %}

{% block script %}
  {{block.super}}

  // On close event of reveal-modal (alertModal) -------------------------------------------------------------
    $(document).on('closed.fndtn.reveal', '#alertModal[data-reveal]', function () {
      // Reset reveal-modal content & it's setting
      $("#alertModalLabel").text("<p>Please select course type.</p>");
      $("#alertModal")
        .removeClass("success").removeClass("warning").removeClass("alert").removeClass("small")
        .addClass("medium")
        .find("div.row").addClass("hide");
    });

  /* Change event: Coures Type
    * Populate Announced Courses in data-table of selected course type
    */
  $("select#nussd_course_type").change(function() {
    if ($(this).prop("selectedIndex") == 0) {
      $("#panel_announce_course").html("<p>Please select course type.</p>")
      return;
    }

    success_state = false;
    var nussd_course_type = $("#nussd_course_type").val();
    var start_enroll = $("#start_enroll").val();
    var end_enroll = $("#end_enroll").val();
    var column_headers = {};
    var ac_data_set = [];

    $.ajax({
      url: "{% url 'get_announced_courses_with_ctype' group_id %}",

      data: {
        nussd_course_type: nussd_course_type,
        ann_course_type: 1,
        start_enroll: start_enroll,
        end_enroll: end_enroll
      },

      type: "GET",

      dataType: "json",

      complete: function () {
        // Enable AC field
        $("select#acourse_list").removeAttr('disabled')

        {% if ac_node %}
        $("select#acourse_list").val("{{ac_node.pk}}");
        $("select#acourse_list").trigger("change");
        {% endif %}
      },

      success: function(data){
        success_state = data["success"]
        if (success_state){
          column_headers = data["column_headers"];
          console.log("column_headers: " + JSON.stringify(column_headers));
          ac_data_set = data["ac_data_set"];
          console.log("ac_data_set: " + JSON.stringify(ac_data_set));
          console.log("ac_data_set: " + ac_data_set.length);

          dataTable_columns_set = [];

          if (ac_data_set.length > 0) {
            // Define table
            ac_table = '<table cellpadding="0" cellspacing="0" border="0" class="display" id="ac_table"></table>';
            $("#panel_announce_course").html(ac_table);

            // Prepare title & data headers used in dataTable
            $.each(column_headers, function(index, v) {
              d = {};
              d["data"] = v[0];
              d["title"] = v[1];
              dataTable_columns_set.push(d);
            });

            // Set defintion dataTable
            $("#ac_table").dataTable({
              "data": ac_data_set,
              "columns": dataTable_columns_set,
              "createdRow": function ( row, data, index ) {
                // Attaching Announced Course's ObjectId to each row (i.e., assigning to it's id attribute)
                $(row).attr("id", data["ac_id"]);
              }
            });
          }
        }
        else {
          $("select#nussd_course_type").prop("selectedIndex", 0);
          
          $("#alertModalLabel").text(data["message"]);
          $("#alertModal").addClass("alert").addClass("small");
          $("#alertModal").foundation('reveal', 'open');
        }
      },
    });//end of ajax
  });

  var selected_ann_courses_ids = [];
  $(document).on( 'click', '#ac_table tbody tr', function () {
    var id = this.id;
    var index = $.inArray(id, selected_ann_courses_ids);

    if ( index === -1 ) {
      selected_ann_courses_ids.push( id );
    } else {
      selected_ann_courses_ids.splice( index, 1 );
    }

    $(this).toggleClass('selected');
  } );
{% endblock %}

{% block document_ready %}
  {{block.super}}

  $('#start_enroll').removeClass("date_month_day_year").addClass("dmy");
  $('#end_enroll').removeClass("date_month_day_year").addClass("dmy");

  /* Change placeholders for date widgets
     From DD/MM/YYYY HH:MM to MM/YYYY
    */
  $(".dmy").each(function(i) {
    $(this).attr("placeholder", "MM/DD/YYYY");
    if ($(this).attr("id") == "start_enroll") {
      var st = "{{node.start_enroll|date:'d/m/Y'}}"
      $(this).val(st)
    }

    else if ($(this).attr("id") == "end_enroll") {
      var et = "{{node.end_enroll|date:'d/m/Y'}}"
      $(this).val(et)
    }
  });

  // Enroll: start & end date-widgets --------------------------------------------------------------------------
  var startEnrollDt = $("#start_enroll");
  var endEnrollDt = $("#end_enroll");
  currentDate = new Date();
  var currentDay = currentDate.getDate();
  var currentMonth = currentDate.getMonth();
  var currentYear = currentDate.getFullYear();

  $(".dmy").datepicker({
    changeMonth: true,
    dateFormat: 'dd/mm/yy',
    minDate: '0',
    maxDate: '+2m',
    defaultDate: '0',

    onClose: function(dateText, inst) {
      $(this).val(dateText);
      
      var month_year = $(this).val();
      day = currentDay;
      month = currentMonth;
      year = currentYear;
      
      if ($(this).attr('id') == "start_enroll") {
        if (month_year) {
          month_year = month_year.split("/");
          day = parseInt(month_year[0]);
          month = parseInt(month_year[1]);
          year = parseInt(month_year[2]);
        }

        if (endEnrollDt.val() != '') {
          var testStartDate = startEnrollDt.datepicker('getDate');
          var testEndDate = endEnrollDt.datepicker('getDate');

          if (testStartDate > testEndDate) {
            endEnrollDt.datepicker('setDate', testStartDate);
          }

          else {
            $(this).val(day+"/"+month+"/"+year);
            $(this).datepicker('setDate', new Date(year, (month-1), day));
          }
        }

        else {
          endEnrollDt.val(day+"/"+month+"/"+year);
          $(this).datepicker('setDate', new Date(year, (month-1), day));
        }
        $("#end_enroll").datepicker('option', 'minDate', new Date(year, (month-1), day));
      }

      else if ($(this).attr('id') == "end_enroll") {
        if (month_year) {
          month_year = month_year.split("/");
          day = parseInt(month_year[0]);
          month = parseInt(month_year[1]);
          year = parseInt(month_year[2]);
        }

        if (startEnrollDt.val() != '') {
          var testStartDate = startEnrollDt.datepicker('getDate');
          var testEndDate = endEnrollDt.datepicker('getDate');

          if (testStartDate > testEndDate) {
            startEnrollDt.datepicker('setDate', testEndDate);
          }
          else {
            $(this).val(day+"/"+month+"/"+year);
            $(this).datepicker('setDate', new Date(year, (month-1), day));
          }
        }

        else {
          startEnrollDt.val(day+"/"+month+"/"+year);
          $(this).datepicker('setDate', new Date(year, (month-1), day));
        }
      }
    },

    beforeShow: function() {
      var month_year = $(this).val();
      day = currentDay;
      month = currentMonth;
      year = currentYear;

      if (month_year) {
        month_year = month_year.split("/");
        day = parseInt(month_year[0]);
        month = parseInt(month_year[1]);
        year = parseInt(month_year[2]);
      }
      $(this).datepicker('option', 'defaultDate', new Date(year, (month-1), day));
      $(this).datepicker('setDate', new Date(year, (month-1), day));
    },
  });
{% endblock %}
