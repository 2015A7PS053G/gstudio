{% extends "ndf/mis_base_create_edit.html" %}
{% load i18n %}
{% load ndf_tags %}
{% load pagination_tags %}

{% block style %}
// <style type="text/css">
/* CSS for Multiple-selection (or drawer) widget */
  .divider-line { font-size: xx-large; color:lightgray; }
  .line-height-2 { line-height:2; }
  .line-height-2pt5 { line-height:2.5; }
  .fontsize-x-large { font-size: x-large; }

  .margin-0 { margin: 0 !important ;}

  .resource-drawer { 
    border-color: #D3D3D3; border-style: solid; 
    padding: 0 !important; 
    overflow-y: auto;
  }

  .resource-drawer li.bullet-item:hover{
    background-color: #ecf0f1; cursor:pointer;
  }

  .posted-by{ color: #808080; font-size: small; }

  .selected-resource { background-color:lightgray !important ; }

  .resource-type-image {
    height:40px;    
    background-repeat:no-repeat; background-size: 48px 48px
  }

/* Disable tab's (anchor tag's) click as it's navigation is propagated on buttons (Next & Previous) */
  dl.tabs>dd a.disable {
    pointer-events: none;
    cursor: default;
  }

  .row .row {
    margin: 0 0;
  }

/* Resetting css-properties for fieldset (also legend, input) */
  /* fieldset (padding-bottom) */ 
  fieldset {
    padding: 1.25rem 1.25rem 1.25rem 1.25rem !important;
  }

  /* legend (background-color) */
  fieldset legend {
    background-color: transparent !important;
  }

  /* input (margin) */
  fieldset input {
    margin: 0 !important;
  }

/* Setting css-properties for reveal-modal's label */
  div.reveal-modal > label {
    color: white;
    font-weight: bold;
    font-size: 1rem;
  }

// </style>
{% endblock %}

{% block body_content %} 
  <div id="alertModal" class="reveal-modal medium alert-box radius" data-reveal data-alert>
    <label id="alertModalLabel"></label>
    <a class="close-reveal-modal">&#215;</a>
  </div>

  <form data-abide enctype="multipart/form-data" id="form-edit-node" method="POST" action="">

    <header class="row" style="margin: 1rem 0 0 0 ;">
      <h2 class="small-12 columns">
        {% if node %}
        {% blocktrans with title_var=title node_name=node.name %} Editing {{title_var}}: {{node_name}} {% endblocktrans %}
        {% else %}
        {% blocktrans with title_var=title %} Register an {{title_var}} {% endblocktrans %}
        {% endif %}
      </h2>
    </header>

    <nav class="row" style="margin-top: 0.5rem;">
      <dl class="tabs small-12 columns" data-tab data-options="deep_linking:true">
        <dd>
          <label><h4>{% trans "Fill"%}:&nbsp;&nbsp;</h4></label>
        </dd>

        {% for tab_details in property_order_list %}
        <dd {% if forloop.counter == 1 %}class="active"{% endif %} title="STEP-{{forloop.counter}}: Fill {{tab_details.0|lower}} details...">
          <a href="#panel_{{tab_details.0}}" class="disable">
            {% blocktrans with tab_name=tab_details.0 %} {{tab_name}} {% endblocktrans %}
          </a>
        </dd>
        {% endfor %}
      </dl>
    </nav>

    {% csrf_token %}

    <div id="announced-course-edit-div" class="tabs-content" style="border-style: solid; border-width: 1.5px; border-color: #0eacb5; padding: 0px 5px;" >
      <div class="active content row" id="panel_{{property_order_list.0.0}}">
        <!-- fieldset for search criteria //////////////////////////////////////////////////////////////////// -->
        <fieldset id="sc">
          <legend><label><h5>Search Criteria</h5></label></legend>
          <div class="row">
            <div class="small-3 columns">
              <label for="NUSSD Course Duration/Period" class="right inline"> 
                {% trans "NUSSD Course Duration/Period" %}
              </label>
            </div>
            <div class="small-1 columns">
              <label for="{{property_order_list.0.1.0.name}}" class="right inline"> 
                {% trans "From" %}
              </label>
            </div>
            <div class="small-2 columns">
              {% html_widget groupid node.pk property_order_list.0.1.0 %}
            </div>
            <div class="small-1 columns">
              <label for="{{property_order_list.0.1.1.name}}" class="right inline"> 
                {% trans "To" %}
              </label>
            </div>
            <div class="small-2 columns end">
              {% html_widget groupid node.pk property_order_list.0.1.1 %}
            </div>
          </div>

          <div class="row">
            <div class="small-3 columns">
              <label for="{{property_order_list.0.1.2.name}}" class="right inline"> 
                {% blocktrans with label_val=property_order_list.0.1.2.altnames %} {{label_val}} {% endblocktrans %}
              </label>
            </div>
            <div class="small-6 columns end" style="width: 51.4%;">
              {% html_widget groupid node.pk property_order_list.0.1.2 %}
            </div>
          </div>

          <div class="small-2 small-centered columns">
            <input type="button" id="find_ac" value="Find" class="button small round expand"/>
          </div>
        </fieldset>

        <!-- fieldset for listing Unset Announced courses based on serach criteria /////////////////////////// -->
        <fieldset id="unset-ac" style="display: none">
          <legend>
            <label><h5>Search Results : <input type="checkbox" id="selectAllOptions" checked="" /> Select/Deselect All</h5></label>
          </legend>
          <div class="row" id="unset-ac-options-div" style="padding-bottom: 1rem;">
            
          </div>
        </fieldset>
        
        <div class="row tab-nav">
          <div class="small-2 columns for-prev">
          </div>
          <!-- 
          <div class="small-4 small-offset-5 columns end for-save">
          </div>
          -->
          <div class="small-2 small-offset-8 columns for-next">
          </div>
        </div>    
      </div>

      <input type="hidden" id="name" name="name" value="">
    </div>
  </form>

{% endblock %}

{% block script %}
// <script type="text/javascript">
// Function to hide fieldset & submit ----------------------------------------------------------------------------
  function hideFieldsetSubmit() {
    if ($("#announce-course").css("display") == "block") {
      $("#announce-course").toggle();
    }

    if ($("#unset-ac").css("display") == "block") {
      $("#unset-ac-options-div").empty();
      $("#unset-ac").toggle();
    }
  }

// Default settings for date-widgets & tabs on page load ---------------------------------------------------------
  var currentYear = (new Date()).getFullYear()
  lowerYearLimit = currentYear - 5;
  upperYearLimit = currentYear + 5;

  $(document).ready(function() {
    // Change placeholders for start-time & end-time
      // From MM/DD/YYYY HH:MM to MM/YYYY
      $(".date_month_day_year").each(function(i) {
        $(this).attr("placeholder", "MM/YYYY");

      // Below code is required because in validators "m/d/Y H:i" is set
      // In order to override that, below code is overwritten
        if ($(this).attr("id") == "start_time") {
          var st = "{{node.start_time|date:'m/Y'}}"
          // alert("start_time: " + st)
          $(this).val(st)
        }

        else if ($(this).attr("id") == "end_time") {
          var et = "{{node.end_time|date:'m/Y'}}"
          // alert("end_time: " + et)
          $(this).val(et)
        }
      });

    // Tabs: Adding Next and Previous buttons for navigation -----------------------------------------------------
      $(".content").each(function(i) {
        totalTabs = $(".content").size() - 1

        if (i != totalTabs) {
          // Not in last tab
          $(this).children(".tab-nav").children(".for-next")
            .append("<input type='button' class='button small round tab_next' value='{% trans 'Next' %}' />");
        }

        if (i == totalTabs) {
          // Only in last tab
          var is_existing_nussd_course = "{{node.pk|default_if_none:''}}";
          var submit_btn_label = '{% trans "Announce" %}' // By default considering registering a new nussd_course
          if (is_existing_nussd_course) {
            // If value (ObjectId) found, it means updating existing nussd_course record
            submit_btn_label = '{% trans "Update" %}'
          }
          $(this).children(".tab-nav").children(".for-next")
            .append("<input type='submit' id='announce-course' class='small button expand' value='"+submit_btn_label+"' style='float:right; display: none' />");
        }

        if (i != 0) {
          // Not in first tab
          $(this).children(".tab-nav").children(".for-prev")
            .append("<input type='button' class='button small round tab_prev' value='{% trans 'Previous' %}' style='float:right;' />");
        }
      });

    // Settings for datepicker widget (with month & year) --------------------------------------------------------
      var startDtInput = $("#start_time");
      var endDtInput = $("#end_time");

      $(".date_month_day_year").datepicker({
        changeMonth: true,
        changeYear: true,
        dateFormat: 'mm/yy',
        yearRange: "" + lowerYearLimit + ":" + upperYearLimit,

        onClose: function(dateText, inst) {
          $(this).val(dateText);
          
          var month_year = $(this).val();

          var month = 1
          var year = lowerYearLimit

          if ($(this).attr('id') == "start_time") {
            if (month_year) {
              month_year = month_year.split("/")
              
              month = parseInt(month_year[0])
              year = parseInt(month_year[1])
            }

            if (endDtInput.val() != '') {
              var testStartDate = startDtInput.datepicker('getDate');
              var testEndDate = endDtInput.datepicker('getDate');

              if (testStartDate > testEndDate) {
                endDtInput.datepicker('setDate', testStartDate);
              }

              else {
                $(this).datepicker('option', 'defaultDate', new Date(year, (month-1), 1));
                $(this).datepicker('setDate', new Date(year, (month-1), 1));
              }
            }

            else {
              endDtInput.val(dateText);

              $(this).datepicker('option', 'defaultDate', new Date(year, (month-1), 1));
              $(this).datepicker('setDate', new Date(year, (month-1), 1));
            }

            $("#end_time").datepicker('option', 'minDate', new Date(year, (month-1), 1));
          }

          else if ($(this).attr('id') == "end_time") {
            if (month_year) {
              month_year = month_year.split("/")

              month = parseInt(month_year[0]);
              year = parseInt(month_year[1]);
            }

            if (startDtInput.val() != '') {
              var testStartDate = startDtInput.datepicker('getDate');
              var testEndDate = endDtInput.datepicker('getDate');

              if (testStartDate > testEndDate) {
                startDtInput.datepicker('setDate', testEndDate);
              }

              else {
                $(this).datepicker('option', 'defaultDate', new Date(year, (month-1), 1));
                $(this).datepicker('setDate', new Date(year, (month-1), 1));
              }
            }

            else {
              startDtInput.val(dateText);

              $(this).datepicker('option', 'defaultDate', new Date(year, (month-1), 1));
              $(this).datepicker('setDate', new Date(year, (month-1), 1));
            }

            $("#start_time").datepicker('option', 'maxDate', new Date(year, (month-1), 1));
          }
        },

        beforeShow: function() {
          // alert("beforeShow")
          // month[0]: month-value   =======   month[1]: year-value
          // NOTE: Experienced an odd behavior which is stated as follows:
          // > Month-value was automatically getting incremented by 1 except only when it is 1
          // > Hence, to tackle that I'm explicitly subtracting 1 from it!
          // > and in case of 1 making it 2 & then subtracting 1 from it!

          var month_year = $(this).val();
          month = 1
          year = lowerYearLimit
  
          if (month_year) {
            month_year = month_year.split("/")
  
            month = parseInt(month_year[0])
            year = parseInt(month_year[1])
          }

          // if (month == 1) {
          //   month = 2;
          // }
          // alert("month: " + month + typeof(month))
          // alert("year: " + year + typeof(year))

          $(this).datepicker('option', 'defaultDate', new Date(year, (month-1), 1));
          $(this).datepicker('setDate', new Date(year, (month-1), 1));
        },

        onChangeMonthYear: function(year, month, inst){
          $(this).val(month+"/"+year)

          hideFieldsetSubmit();
        }
      });

    // If Find button is disabled, enable it
      if ($("#find_ac").attr("disabled") == "disabled") {
        $("#find_ac").removeAttr("disabled");
      }
  });

// Tabs navigation: Enable and Disable tabs in sequential manner using Next & Previous buttons -------------------
  $(".content").on('click', '.tab_next', function(event){
    event.preventDefault();

    // Forcefully blur all input elements, so that mandatory fields become data-invalid if not fill
    $(this).parents(".tab-nav").parents(".content").find(':input[required]').blur();

    // Then check no. of data-invalid fields
    // if count == 0, then only proceed to next tab
    if($(this).parents(".tab-nav").parents(".content").find(':input[data-invalid]').length == 0) {
      // Valid, move to next step
      $('.active').removeClass('active').next().addClass('active');
    }
  });

  $(".content").on('click', '.tab_prev' ,function(event){
    event.preventDefault();
    $('.active').removeClass('active').prev().addClass('active');
  });

// Only keeping month's & year's drop-down and hiding other datepicker's elements --------------------------------
  $(document).on('focus click', '.date_month_day_year' ,function(){
    $(".ui-datepicker-calendar").hide();
  });

// If any of the Input field of fieldset (sc) is changed -------------------------------------------------
  $("#sc :input").on('change click', function(){
    // hide fieldsets & submit button 
    hideFieldsetSubmit();

    // Enable Find button (find_ac)
    $("#find_ac").removeAttr('disabled');
  });

// Select/Deselect all checbox(es) ['unset-ac-options'] based on state of checkbox ['selectAllOptions'] ----------
  $("#selectAllOptions").bind("change", function(){
    selectAllState = this.checked;
    $("input[name='unset-ac-options']").each(function() {
      $(this).prop("checked", selectAllState);

    // Enable/Disable Announce (submit) button, if none of the checkbox is selected
      $("#announce-course").attr("disabled", !selectAllState);
    });
  });

// Select/Deselect selectAllOptions checkbox & Enable/Disable Announce (submit) button ---------------------------
  $(document).on("change click", ".unsetOption", function(){
    optionState = $(this).prop("checked");
    
  // Select/Deselect selectAllOptions checkbox, if any of the unset-check-options is unchecked
    if (!optionState) {
      selectAll = $("#selectAllOptions");
      if (selectAll.prop("checked")) {
        selectAll.prop("checked", optionState);
      }
    }

  // Enable/Disable Announce (submit) button, if none of the checkbox is selected
    $("#announce-course").attr("disabled", !optionState);
  });

// On click of Find (Setup Ajax call) ----------------------------------------------------------------------------
  $("#find_ac").click(function(event) {
    // alert("AC Find clicked...")
    event.preventDefault();

    // Forcefully blur all input elements, so that mandatory fields become data-invalid if not fill
    $(this).parents("fieldset").parents(".content").find(':input[required]').blur();

    // Then check no. of data-invalid fields
    // if count == 0, then only proceed to make ajax-call & later on successful returned O/P, displaying Announce(submit) button
    if($(this).parents("fieldset").parents(".content").find(':input[data-invalid]').length == 0) {
      var start_time = $("#start_time").val()
      var end_time = $("#end_time").val()
      var nussd_course_type = $("#nussd_course_type").val()
      var success_state = false
      // alert("\n start_time: " + start_time + "\n end_time: " + end_time + "\n nussd_course_type: " + nussd_course_type)

      // All field(s) have valid I/P, make ajax-call
      $.ajax({
        url: "{% url 'get_announced_courses' group_id %}",

        data: {
          start_time: start_time,
          end_time: end_time,
          nussd_course_type: nussd_course_type
        },

        type: "GET",

        dataType: "json",

        success: function(data){
          // alert("Output" + "\n success: " + data);

          // var dataDict = JSON.parse(data.responseText);
          // alert(" " + data["success"] + " -- " + typeof(data["success"]))          
          success_state = data["success"];
          $("#alertModalLabel").text(data["message"]);

          if (data["success"]) {
            $("#alertModal").removeClass("alert");
            $("#alertModal").addClass("success");
            $("#alertModal").foundation('reveal', 'open');

            $("#unset-ac-options-div").empty();
            // alert("length: " + Object.keys(data["unset_nc"]).length)
            var dict_len = Object.keys(data["unset_nc"]).length;
            $.each(data["unset_nc"], function(k, val){
              // alert(k + " -- " + val);
              input_chk = ""
              if (dict_len != 1) {
                input_chk += "<div class='small-12 columns'>" 
              }

              else {
                input_chk += "<div class='small-12 columns end'>" 
              }
              
              v = k + ">>" + val;

              input_chk += "<input type='checkbox' name='unset-ac-options' class='unsetOption' checked='' value='"+v+"'/>" + 
                            "<label>"+val+"</label>" +
                            "</div>";
              $("#unset-ac-options-div").append(input_chk);
              
              dict_len = dict_len - 1;
            });

            // If nussd_course_type is Foundation Course disable all checkboxes
            if (nussd_course_type == "Foundation Course") {
              // alert("Foundation Course found!")
              $("#selectAllOptions").attr("disabled", "disabled");
              $(".unsetOption").attr("disabled", "disabled");
            }

            else {
              $("#selectAllOptions").removeAttr("disabled", "disabled");
              $(".unsetOption").removeAttr("disabled", "disabled");
            }
          }

          else {
            $("#alertModal").removeClass("success");
            $("#alertModal").addClass("alert");
            $("#alertModal").foundation('reveal', 'open');
          }
        },

        complete: function(){
          // var respDict = JSON.parse(resp.responseText);
          if (success_state) {
            // If unset NUSSD course(s) found, display Announce(submit) button only if it's hidden
            if ($("#announce-course").css("display") == "none") {
              $("#announce-course").toggle();
            }

            // Also toggle unset-ac fieldset
            if ($("#unset-ac").css("display") == "none") {
              $("#selectAllOptions").prop("checked", true);
              $("#unset-ac").toggle();
            }
          }

          else {
            // Otherwise, hide button as well as fieldset
            if ($("#announce-course").css("display") == "block") {
              $("#announce-course").toggle();
            }

            // Also toggle unset-ac fieldset
            if ($("#unset-ac").css("display") == "block") {
              $("#unset-ac-options-div").empty();
              $("#unset-ac").toggle();
            }
          }
        }
      });
    }
  });

// On close event of reveal-modal (alertModal) -------------------------------------------------------------
  $(document).on('closed.fndtn.reveal', '#alertModal[data-reveal]', function () {
    if ($(this).hasClass('success')) {
      // Disable 'Find' button, which gets enable only when any of the input element
      // of the fieldset (fsSc) is changed
      $("#find_ac").attr('disabled', "disabled");
    }
  });

// On click of Register/Update -----------------------------------------------------------------------------------
  $(document).on("click", "#announce-course", function() {
  // Enable any disabled field as disabled values can't be fetched in views --------------------------------------
    $("#selectAllOptions").removeAttr("disabled", "disabled");
    $(".unsetOption").removeAttr("disabled", "disabled");
  });
{% endblock %}
