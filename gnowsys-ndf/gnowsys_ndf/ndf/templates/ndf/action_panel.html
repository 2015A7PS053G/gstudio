{% load ndf_tags %}
{% load i18n %}
{% load cache %}
{% user_access_policy groupid request.user as user_access %}
{% get_group_object groupid as group_object %}
{% with user.is_authenticated as is_user_authenticated %}
{% check_is_gstaff groupid request.user as is_gstaff %}
{% check_group node as is_group %}
{% check_is_user_group node.pk as is_user_group %}
<style type="text/css">
	.right-btn, .left-btn{
		/*float: left;*/
		/*margin-left: 1rem;*/
		width: 40%;
		font-size: 0.60em !important;
		margin-top: 0.1rem !important;
	}
	}
	.tag-rating-div{
		margin-left: 0.1rem !important;
		margin-top: 0.3rem !important;
	}
	/*	
	.right-btn{
		float: right;
		margin-right: 1rem;
		width: 8rem;
		font-size: 0.75rem !important
	}
	*/
	.rating-lbl{
		display: inline-block;
		font-size: 1rem !important;
		/*font-style: italic;*/
		/*margin-left: 3rem;*/

	}
	.rating_template{
		display: inline-table;
	}
	.mod-btn{
		width: 16.30rem !important;
		font-size: 0.75rem !important;
	}
	.btn-row{
		/*margin-left: 1rem !important;*/
		text-align: center;
		margin-bottom: -1rem !important;
	}
	.lbl_tag{
		display: inline-block;
		font-size: 0.80rem !important;
	}
	.lbl_field{
		width: 4rem;
		color: #194d6f;
		/*font-weight: bold;*/
		margin-top: 1rem;
		font-size: 1rem !important;
		margin-left:10%;
	}
	.location-div{
		margin-left:10%;


	}
	.label > a{
		color: white !important;
	}

	.graph_btn{
		margin-left: 3rem;
	}
</style>
<section class="medium-3 columns"> 
	<ul class="side-nav">

		<!-- PANEL 1
		 Resource related Actions such as 
			Edit, Publish, Delete, History,
			Translate, Cross Publish,
			Tags
		 -->
		<div class="panel">
			<!-- Edit and Publish -->
				<div class="row btn-row">
					<!-- Edit button -->
						{% edit_policy groupid node request.user as status %}
						{% if is_user_authenticated and status == "allow" and user_access == "allow" %}
							{% get_sg_member_of groupid as list_of_sg_member_of %}
							{% if "ProgramEventGroup" not in list_of_sg_member_of %}
							{% get_edit_url node.pk as edit_url %}
							{% if is_group %}
								{% if is_gstaff %}
									<a href="{% url edit_url group_id %}" class="tiny button radius left-btn edit fi-pencil">{% trans " Edit" %}</a>
								{% endif %}
							{% else %}
								{% if user_is_joined == "joined" or user_is_joined == "author" or is_gstaff %}
									<a href="{% url edit_url group_id node %}" class="tiny button radius edit left-btn fi-pencil">{% trans " Edit" %}</a>
								{% endif %}
							{% endif %}
							{% endif %}
						{% else %}
							<input type="button" class="tiny button radius secondary edit left-btn fi-pencil disabled" value="Edit">
						{% endif %}


					<!-- Publish button -->
					{% if node %}
						{% get_publish_policy request groupid node as group_policy %}
						{% if group_policy == "allow" %}
							{% if is_group %}
								{% if user.is_superuser or node.created_by == user.id %}
									<a href="{% url 'publish_group' group_id node %}" class="tiny button radius edit right-btn">{% trans "Publish" %}</a>
								{% endif %}
							{% else %}
								<a href="{% url 'publish_page' group_id node %}" class="tiny button radius edit right-btn">{% trans "Publish" %}</a>
							{% endif %}
						{% elif group_policy == "MODERATION" %}
							<a class="tiny button radius edit right-btn secondary disabled">{% trans "Moderation" %}</a>
						{% else %}
							<a class="tiny button radius edit right-btn secondary disabled">{% trans "Published" %}</a>
						{% endif %}
					{% endif %}
				</div>

			{% if node.status != "MODERATION" %}
			<!-- Delete and History -->
				<div class="row btn-row">
					<br/>
					<!-- Delete button				 -->
					{% if user.is_authenticated and "Group" in group_object.member_of_names_list %} 
						{% if node.created_by == request.user.id %}
							{% if "Page" in node.member_of_names_list %}
								<a class="tiny button radius left-btn fi-trash" href="{% url 'trash_resource' group_id node %}">{% trans " Delete" %}</a>
							{% elif "Term" in node.member_of_names_list %}
								<a class="tiny button radius left-btn fi-trash" href="{% url 'term_delete' group_name_tag node %}">{% trans " Delete" %}</a>
							{% else %}
								<a class="tiny button radius left-btn fi-trash disabled secondary" href="#" >{% trans " Delete" %}</a>
							{% endif %}
						{% else %}
							<input type="button" class="tiny button radius left-btn fi-trash secondary disabled" value="{% trans 'Delete' %}">
						{% endif %}
						<!-- History -->
						<a href = "{% url 'node_version' groupid node.pk  %}" class="tiny button radius right-btn" >{% trans "History" %}</a> 
					{% else %}
						<input type="button" class="tiny button radius left-btn fi-trash secondary disabled" value="{% trans 'Delete' %}">
						<input type="button" class="tiny button radius left-btn secondary disabled" value="{% trans 'History' %}">
					{% endif %}
				</div>

			{% if not is_group %}

			<!-- Translate and Cross Publish if not is_group-->

				<div class="row btn-row">

					<!-- Translate -->
					{% if user.is_authenticated %}
						{% if user_is_joined == "joined" or user_is_joined == "author" %}
							<a href="{% url 'node_translation' group_name_tag node %}" class="tiny button radius left-btn">{% trans "Translate" %}</a>
						{% endif %}
						<!-- Cross Publish -->
						{% if 'CourseEventGroup' not in group_object.member_of_names_list %}
							<!-- {% switch_group_conditions request.user group_id as switch_conditions %} -->
							<!-- If resource is already under moderation, don't show cross-publish button -->
								<span data-tooltip title="Publish this resource in other group/s" class="has-tip tip-bottom"><a id="switch_group" class="tiny button radius right-btn" data-reveal-id="publish_resource"> {% trans "Cross Publish" %}</a></span>
								<div id="publish_resource" class="reveal-modal" data-reveal style="position:absolute;"> 
									<div id="switchgrp" class="content">
									<h4>{% trans "Select Groups" %}</h4>
									<div id="group_drawer">
									{% include "ndf/drawer_widget.html" with widget_for="collection_set" %}
									</div><br/>
									<input type="button" id="save_switch_group" class="round button push-4" value="{% trans 'Save selected group' %}">
									</div>
									<a class="close-reveal-modal">&#215;</a>
								</div>          

						{% endif %}

					{% else %}
						<input type="button" class="tiny disabled secondary button radius left-btn" value="{% trans "Translate" %}" >
						<span data-tooltip title="Publish this resource in other group/s" class="has-tip tip-bottom"><input type="button"class="secondary disabled tiny button radius right-btn" value="{% trans 'Cross Publish' %}"></span>
					{% endif %}
				</div>

			<!-- Tags row -->
				<div class="row tag-rating-div">
					<span data-tooltip title="'keyword' or 'label' to categorize"><label class="lbl_tag lbl_field">{% trans "Tags" %}</label></span>
						{% if node.tags %}
							{% for tag in node.tags %}
								{% if forloop.counter < 3 %}
									<small><label class="lbl_tag label">
								{% else %}
									<small><label class="lbl_tag label tag_ele hide">
								{% endif %}
								<a href="{% url 'tag_info' groupid tag %}">{{tag}} </a></label></small>
							{% endfor %}
							{% if node.tags|length > 3 %}
								<small><label class="view-more-tags" style="display:inline-block;">More</label></small>
							{% endif %}	
						{% else %}
						<i><small><label class="lbl_tag">{% trans "No tags defined yet!" %}</label></small></i>
						{% endif %}
				</div>

			<!-- Ratings -->
				{% if group_object.edit_policy != "EDITABLE_MODERATED" or "CourseEventGroup" in group_object.member_of_names_list %}
					{% if "File" in node.member_of_names_list or "Page" in node.member_of_names_list %}
					{% get_list_of_fields node.type_of "name" as type_of_list %}
					{% if "Info page" not in type_of_list %}
					<div class="row tag-rating-div">
						<span data-tooltip title="Rating defines popularity">
							<label class="lbl_tag lbl_field">{% trans "Rating" %}</label>
						</span>
						<div class="rating_template"> {% include "ndf/rating.html" %} </div>
					</div>
					{% endif %}
					{% endif %}
				{% endif %}
			
			<!-- Location	-->
				<div class="row tag-rating-div">
				{% if node.location %}
		        	<a data-reveal-id="view-map-widget" class="location-div"><i class="fi-marker"></i> {% trans "Location" %}</a>
	        	{% else %}
		        	<a class="location-div disabled text-gray"><i class="fi-marker"></i> {% trans "Location" %}</a>
	        	{% endif %}

		    <!-- Graphs For Topics or Concept -->
		      {% if "Topic" in node.member_of_names_list or "Concept" in node.member_of_names_list %}
		        <!-- Below code/widgets will only be shown for all resource instances/documents
		             which are Topic or Concept
		        -->

		        <a href="#" class="text-right graph_btn" data-dropdown="graph-list" data-options="is_hover:true;align:left"><i class="fi-share"></i> {% trans "Graphs" %}</a>
		        
		        <ul id="graph-list" class="f-dropdown" data-dropdown-content>
		          <li><a href="#view-concept-graph" data-reveal-id="view-concept-graph" id="clickConceptGraph">{% trans "Concept Graph" %}</a></li>

		          {% if node.collection_set %}
		          <li><a href="#view-collection-graph" data-reveal-id="view-collection-graph">{% trans "Collection Graph" %}</a></li>
		          {% endif %}

		          {% if node.prior_node %}
		          <li><a href="#view-dependency-graph" data-reveal-id="view-dependency-graph">{% trans "Dependency Graph" %}</a></li>
		          {% endif %}               
		        </ul>
		      {% endif %}
	
		        </div>
			{% endif %}

			{% endif %}
		</div>

		<!-- PANEL 2
		New {{node}} and Group related actions such as
		Group Analytics, New Subgroup, New ProgramEvent,
 		-->		
		{% if 'ModeratingGroup' not in group_object.member_of_names_list and 'ProgramEventGroup' not in group_object.member_of_names_list %}
		<div class="panel">

			<div class="row btn-row">
				<!-- New (GS) -->
					{% get_create_url node.pk as create_url %}
					{% if user.is_authenticated %}
						{% if is_group %}
							<!-- Prevent creating New group from context of top mod group -->
							{% if group_object.edit_policy != "EDITABLE_MODERATED" and is_gstaff %}
								<a href="{% url create_url group_name_tag %}" class="tiny button radius edit left-btn">{% trans 'New Group' %}</a>
							{% else %}
								<input type="button" class="tiny button secondary radius disabled edit left-btn" value="New {{node.member_of_names_list.0}}" >
							{% endif %}								
						{% else %}
							{% if user_is_joined == "joined" or  user_is_joined == "author" %}
								{% if node.status != 'MODERATION' %}
									{% if "File" in node.member_of_names_list %}
										<a href="{% url create_url group_name_tag %}?next={{request.path}}" class="tiny button radius edit left-btn">{% trans "New" %} {{node.member_of_names_list.0}}</a>
									{% else %}
										{% if "Theme" in node.member_of_names_list or "Topic" in node.member_of_names_list %}
											<a href="{% url create_url group_name_tag app_id %}" class="tiny button radius edit left-btn">{% trans "New" %} {{node.member_of_names_list.0}}</a>
										{% elif "Term" in node.member_of_names_list %}
											<a href="{% url create_url group_name_tag %}" class="tiny button radius edit left-btn">{% trans "New" %} Topic
											</a>
										{% elif "Group" not in node.member_of_names_list and "ProgramEventGroup" not in node.member_of_names_list and "CourseEventGroup" not in node.member_of_names_list and "ModeratingGroup" not in node.member_of_names_list %}
											<a href="{% url create_url group_name_tag %}" class="tiny button radius edit left-btn">{% trans "New" %} {{node.member_of_names_list.0}}</a>
										{% endif %}
									{% endif %}
								{% endif %}
							{% endif %}
						{% endif %}
					{% else %}
						<input type="button" class="tiny button radius secondary disabled edit left-btn" value="New {{node.member_of_names_list.0}}" >	
					{% endif %}
				
				<!-- Group Analytics -->
				<a href="/{{group_id}}/analytics/group/summary/" class="tiny button radius right-btn">{% trans 'Group Analytics' %}</a>
			</div>

			{% if is_group and group_object.edit_policy != "EDITABLE_MODERATED"%}
			<div class="row btn-row">
				<!-- New SubGroup and PE-->
					{% if user.is_superuser %}
						<a href="{% url 'create_sub_group' group_id %}" class="tiny button radius left-btn">{% trans "New SubGroup" %}</a>

						<a href="{% url 'create_event_group' group_id 'ProgramEventGroup' %}" class="tiny button radius right-btn">{% trans "New Programs" %}</a>
					{% endif %}
			</div>
			{% endif %}
		</div>
		{% endif %}

		<!-- PANEL 3
		Group subscription related actions such as
		List Members, Join/Unsubscribe,
		Subscribe Users, Subscribe Admins
 		-->
		{% if is_group and not is_user_group %}

		<div class="panel">
			{% if 'ModeratingGroup' not in group_object.member_of_names_list and 'ProgramEventGroup' not in group_object.member_of_names_list %}
				<!-- List Members and Join buttons -->
				<div class="row btn-row">
					<!-- List Members -->
						<a href="#" id ="btn_list_member" class="tiny button radius left-btn" data-reveal-id="firstModal">{% trans "List Members" %}</a>
						<!-- Reveal Modals begin -->
						<div id="firstModal" class="reveal-modal" data-reveal></div>
					<!-- Join/ Unsubscribe -->
						{% if user.is_authenticated %}
							{% if not is_gstaff %}
								{% if user_is_joined == "joined" %}
									<input class="tiny button radius right-btn" type="submit" id="notify" value="{% trans 'Unsubscribe' %}"
									{% if group_name_tag == "home" %}
										disabled="disabled" 
									{% endif %}
									>
									{% comment %}
										<input class="tiny button radius right-btn" type="submit" id="notify" value="{% trans 'Stop following' %}">
									{% endcomment %}

								{% elif user_is_joined == "not" %}
									{% if allow_to_join %}
									<input class="tiny button radius right-btn" type="submit" id="notify" value="{% trans 'Join' %}">
									{% else %}
									<input class="tiny button radius secondary disabled right-btn" type="button" id="notify" value="{% trans 'Closed' %}">
									{% endif %}
									{% comment %}
										<input class="tiny button radius right-btn" type="submit" id="notify" value="{% trans 'Follow' %}">
									{% endcomment %}
								{% endif %}
							{% else %}
								<input class="tiny button radius secondary disabled right-btn" type="button" value="{% trans 'Joined' %}" >
							{% endif %}
						{% else %}
							<input class="tiny button radius disabled secondary right-btn" type="button" value="{% trans 'Join' %}" >
						{% endif %}
				</div>
			{% endif %}
            {% if is_gstaff %}

			<!-- Subscribe Users and Subscribe Admins buttons-->
			<div class="row btn-row">
				{% include "ndf/invite_users.html" %}
				{% include "ndf/invite_admins.html" %}
			</div>

			<!-- Moderate Resources or Moderation Status button -->
            <div class="row btn-row">
				{% if group_object.edit_policy == "EDITABLE_MODERATED" and "CourseEventGroup" not in group_object.member_of_names_list %}
					{% if 'ModeratingGroup' in group_object.member_of_names_list or 'ProgramEventGroup' in group_object.member_of_names_list and 'Group' not in group_object.member_of_names_list %}
						<a class="tiny expand button radius mod-btn" href="{% url 'moderation' group_name_tag %}">
						{% trans 'Moderate Resources' %}
						</a>
					{% endif %}

					{% if 'Group' in group_object.member_of_names_list %}
						<a class="tiny expand button radius mod-btn" href="{% url 'all_under_moderation' group_id %}">
						{% trans 'Moderation Status' %}
						</a>
					{% endif %} 
				{% endif %} 
            </div>
			{% endif %}
		</div>
		{% endif %} 
	</ul>
</section>
{% endwith %}

<script type="text/javascript">
	$(document).on('click','.view-more-tags',function(){
		if($(this).text()=="Less"){
			$(".tag_ele").addClass("hide")
			$(this).text("More")
		}
		else{
			$(".tag_ele").removeClass("hide")
			$(this).text("Less")
		}
	})
</script>