{% load i18n %}
{% load ndf_tags %}
    <div class="row">
            <div class="small-12 medium-6 large-6 columns">
            <h6>
                &nbsp;&nbsp;&nbsp;<b><u>Asset Content Preview </u>&nbsp; ></b>
               <!-- Resource Name-->
            </h6>
                <label>Resource name: <b> {{node.name}} </b>
                    
                    <!--<input type="text" placeholder="" name="resource_name" />-->
                </label>
            {% if 'video' in node.if_file.mime_type %}
            <div class="video-related">
                <label>Upload Transcript
                </label>
                <div class="transcript_files">
                   <form class="dropzone" id ="doctranscript" enctype="multipart/form-data" method="post" action="{% url 'add_assetcontent' group_id %}" > 
                    <input type="file" placeholder="" id="doctranscriptfile" name="transcript_file" />
                    <span class="add_more_files">&nbsp;<u> + Transcript</u></span>
                    <!-- <a class="right orange-button  save-transcript">Save Asset</a> -->
                    <button type="button" class="right orange-button save-transcript" >Save Asset</button>
                </div>
                <label>Upload Subtitle
                </label>
                <div class="subtitle_files">
                    <form class="dropzone" id ="docsubtitle" enctype="multipart/form-data" method="post" action="{% url 'add_assetcontent' group_id %}" >
                        <input type="file" id="docsubtitlefile" placeholder="" name="doc_f" />
                        <b class="compulsory">Language</b>
                          <select name="lan" id="sub_languageid" tabindex=3 required>
                            <option value="">--- Select Language ---</option>
                            {% get_language_info_list for LANGUAGES as languages %}
                            {% for language in languages %}
                            <option data-sub-lang="{{ language.name }}" data-sub-code="{{ language.code }}">
                              {{ language.name }}
                            </option>
                            {% endfor %}
                          </select>
                        <span class="add_more_files"><u>+ Subtitle</u></span>
                    </form>
                    <button type="button" class="right orange-button" onclick="save_subtitle()">Save Asset</button>
                   <!-- <input type="asset-save-button" id="" class="orange-button" onclick="save_asset_cont_data()" value="Save"/>-->
                </div>
            </div>
            {% endif %}
        </div>
            <div class="small-12 medium-6 large-6 columns">
                <div class="preview_asset"> 
                    {% if title == "asset_content_detail" %}
                        {% include "ndf/resource_view.html" with node=node %}
                    {% endif %}
                </div>
            </div>
        </div>

<script type="text/javascript">
  // var form = document.getElementById('docsubtitle');
  var selectedSubtitle = document.getElementById('docsubtitlefile');
  // var uploadButton = document.getElementById('submitpostid');
        function save_subtitle(event) {

        sel_sub_lang =  $('#sub_languageid').find(':selected').attr('data-sub-lang');
        sel_sub_lang_code =  $('#sub_languageid').find(':selected').attr('data-sub-code');
        // assetval = $('.asset_obj_val').attr('data-asset-obj-val');
        // Update button text.
        // uploadButton.innerHTML = 'Uploading...';

        // Get the selected files from the input.
        var files = selectedSubtitle.files;

        // Create a new FormData object.
        var formData = new FormData();

        // Loop through each of the selected files.
        for (var i = 0; i < files.length; i++) {
          var file = files[i];

          // // Check the file type.
          // if (!file.type.match('image.*')) {  continue; }

          // Add the file to the request.
          formData.append('uploaded_subtitle', file, file.name);
        }

        // appending csrfmiddlewaretoken and user-id
        formData.append('csrfmiddlewaretoken', '{{csrf_token}}');
        formData.append('user','{{request.user.id}}');
        formData.append('if_subtitle','True');
        formData.append('assetcontentid','{{node.pk}}');
        formData.append('sel_sub_lang',sel_sub_lang);
        formData.append('sel_sub_lang_code',sel_sub_lang_code);
        
        if(!"{{asset_obj}}"){
            formData.append('asset_obj',assetval);
        }
        else{
            formData.append('asset_obj','{{asset_obj}}');
        }
        // Set up the request.
        xhr = new XMLHttpRequest();

        // Open the connection.
        xhr.open('POST', "{% url 'add_assetcontent' group_id %}", true);

        // Set up a handler for when the request finishes sucessfully.
        xhr.onload = function () {
          if (xhr.status === 200) 
          {
            // File(s) uploaded.
           // if file is not uploaded sucessfully
            if(xhr.responseText == "UploadError")
            {
               alert("Error occurred");
            }
            // check if image is not in the list, add it.
            else if(xhr.responseText )
            {
              alert(xhr.responseText);
              location.reload();
            }

            uploadButton.innerHTML = 'Upload';

            // updating metadata of files, if file is uploaded sucessfully
            // if(xhr.responseText != "UploadError")
            // {
            //   // alert('xhr.responseText != "UploadError"');
            // }
          }
          else
          {
            alert('An error occurred!');
          }
        };

        // Send the Data.
        xhr.send(formData);
      }

  

  // var form = document.getElementById('docsubtitle');
  $( ".save-transcript" ).click(function() {
  var selectedtrans = document.getElementById('doctranscriptfile');
  // var uploadButton = document.getElementById('submitpostid');
            // console.log(selectedSubtitle)
               // Get the selected files from the input.
            var files = selectedtrans.files;

            // Create a new FormData object.
            var formData = new FormData();

            // Loop through each of the selected files.
            for (var i = 0; i < files.length; i++) {
              var file = files[i];

              // // Check the file type.
              // if (!file.type.match('image.*')) {  continue; }

              // Add the file to the request.
              formData.append('uploaded_transcript', file, file.name);
            }

        // appending csrfmiddlewaretoken and user-id
        formData.append('csrfmiddlewaretoken', '{{csrf_token}}');
        formData.append('user','{{request.user.id}}');
        formData.append('if_transcript','True');
        formData.append('assetcontentid','{{node.pk}}');
        
        if(!"{{asset_obj}}"){
            formData.append('asset_obj',assetval);
        }
        else{
            formData.append('asset_obj','{{asset_obj}}');
        }
        // Set up the request.
        xhr = new XMLHttpRequest();

        // Open the connection.
        xhr.open('POST', "{% url 'add_assetcontent' group_id %}", true);

        // Set up a handler for when the request finishes sucessfully.
        xhr.onload = function () {
          if (xhr.status === 200) 
          {
            // File(s) uploaded.
           // if file is not uploaded sucessfully
            if(xhr.responseText == "UploadError")
            {
               alert("Error occurred");
            }
            // check if image is not in the list, add it.
            else if(xhr.responseText )
            {
              alert(xhr.responseText);
              location.reload();
            }

            //uploadButton.innerHTML = 'Upload';

            // updating metadata of files, if file is uploaded sucessfully
            // if(xhr.responseText != "UploadError")
            // {
            //   // alert('xhr.responseText != "UploadError"');
            // }
          }
          else
          {
            alert('An error occurred!');
          }
        };

        // Send the Data.
        xhr.send(formData);

});
  
</script>


