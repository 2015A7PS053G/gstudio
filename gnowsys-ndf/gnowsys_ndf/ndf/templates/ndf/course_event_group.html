{% extends "ndf/base.html" %}
{% load i18n %}
{% load cache %}
{% load ndf_tags %}
{% block title %} CourseEvent {{node.name}} {% endblock %}
{% block style %}
  .course_outline_table, tr {
    border: 2px solid #0b8a91 !important;
    border-collapse: collapse;
  }

  .gray-text{
    color: gray;
  }

  #content > p { color: #6F6F6F !important; /*font-size: inherit;*/ }


  tr:hover{
    cursor:pointer;
  }

  #upload_form_div{
    display: inline-block;
  }

  .tab{
    padding-left: 2em;
    background-color:yellow !important;
  }

  .tab2{
    padding-left: 4em;
  }

  div.reveal-modal > label {
    color: white;
    font-weight: bold;
    font-size: 1rem;
  }

  .all_blogs{
      overflow-y: auto;
      height:500px;
  }

  .jqtree-tree .jqtree-title {
      margin: 5px;
      font-size: 15px;
      color: black !important;
      /*Change the color here to change font color of tree*/
  }
  
  .jqtree-tree {
      border-color:#0b8a91;
      border-width:1px;
      border-style: solid;
  }



{% endblock %}

{% block head %}
    <script type="text/javascript" src="/static/ndf/orgitdown/jquery.orgitdown-foundation.js"></script>
    <!-- orgitdown! toolbar settings -->
    <script type="text/javascript" src="/static/ndf/orgitdown/skins/gstudio/set.js"></script>
    <!-- orgitdown! skin -->
    <link rel="stylesheet" type="text/css" href="/static/ndf/orgitdown/skins/gstudio/style.css" />

{% endblock %}

{% block meta_content %}
  <h3>Course Outline</h3>
      {% check_is_gstaff groupid request.user as is_gstaff %}
      {% if is_gstaff %}
        <span><a class="tiny button" href="{% url 'create_course_struct' group_id node.pk %}">{% if course_structure_exists %}{% trans "Edit  Course Structure" %}{% else %}{% trans "Add  Course Structure" %}{% endif %}</a></span>
      {% endif %}
  
  <div id="view_collection">
    {% include "ndf/collection_ajax_view.html" %}  
  </div>
{% endblock %}
{% block extended_header %}
    {% get_sg_member_of group_object.pk as list_of_sg_member_of %}
    <div class="row">

      {% if "CourseEventGroup" in group_object.member_of_names_list or "ProgramEventGroup" in list_of_sg_member_of %}
          <nav>
              <section class="medium-3 columns text-center">
              <a href="{% url 'groupchange' group_object.name %}"><b>{% firstof group_object.altnames group_object.name %} </b></a>
              </section>

              {% get_attribute_value group_object.pk 'start_time' as event_start_time %}
              {% get_attribute_value group_object.pk 'end_time' as event_end_time %}
              {% get_attribute_value group_object.pk 'start_enroll' as event_start_enroll %}
              {% get_attribute_value group_object.pk 'end_enroll' as event_end_enroll %}
              
              <section class="medium-4 columns">
                  <label>Event</label>
                  <label> Start: {{event_start_time|date:"d M Y"}} &nbsp;&nbsp; End: {{event_end_time|date:"d M Y"}}</label>
              </section>

              <section class="medium-4 columns">
                  <label>Enrollment</label>
                  <label> Start: {{event_start_enroll|date:"d M Y"}} &nbsp;&nbsp; End: {{event_end_enroll|date:"d M Y"}}</label>
              </section>
              <!-- Right Nav Section -->
              {% if user.is_authenticated %}
                {% get_user_object request.user.id as user_obj %}
                {% check_is_gstaff groupid user_obj as gstaff_access %}
                {% if not gstaff_access %}
                  <section>
                    <ul class="right" >
                    {% user_access_policy groupid request.user as user_access %} 
                      <li>
                      {% if user_access == "allow" %}
                        <input class="enroll-btn button tiny" type="button" value="ENROLLED" disabled="disabled">
                      {% else %}
                        {% if allow_to_join %}
                          <input class="enroll-btn button tiny" type="button" value="ENROLL">
                        {% else %}
                          <input class="button tiny" type="button" value="ENROLL" disabled="disabled">
                        {% endif %}
                      {% endif %}
                      </li>
                    </ul> 
                  </section>
                {% endif %}
              {% endif %}
          </nav>
      {% endif %}

    </div>
{% endblock %}

{% block body_content %}
  {% if user.is_authenticated %}
    {% get_user_object request.user.id as user_obj %}
    {% check_is_gstaff groupid user_obj as gstaff_access %}
  {% endif %}
  <div id="alertModal" class="reveal-modal medium alert-box radius" data-reveal data-alert>
      <label id="alertModalLabel"></label>
      <a class="close-reveal-modal">&#215;</a>
  </div>

	<div id="view-page" class="small-12 large-12 columns"></div>
    <div class="small-12 columns">
      <dl class="tabs" data-tab data-options="deep_linking:true"  > 

          {% user_access_policy node.pk request.user as user_access %} 

            <dd class="tab-title active ">
              <a href="#about-tab"><i class="fi-info "></i> {% trans "About" %}</a>
            </dd>
            <dd class="tab-title">
              <a href="#view_page" class="view_page_link"><i class="fi-list-thumbnails"></i> {% trans "Activities" %}</a>
            </dd>

          {% if user_access == "allow" %}
            <dd class="tab-title ">
              <a href="#journal-tab"><i class="fi-page-edit "></i> {% trans "Note Book" %}</a>
            </dd>

            <dd class="tab-title">
              <a href="#gallery-tab"><i class="fi-photo "></i> {% trans "Gallery" %}</a>
            </dd>

            <dd class="tab-title ">
              <a href="#analytics-tab"><i class="fi-graph-trend "></i> {% trans "Analytics" %}</a>
            </dd>
          {% endif %}
      </dl>


    <div class="row">
      
		<section class="small-12 medium-12 columns content">
      <div class="tabs-content">
        <!-- Tab content -->
        <div class="content active" id="about-tab">
          <div class="row">
            {% include "ndf/res_node_ajax_view.html" %} 
          </div>
        </div>

        <div class="content" id="view_page">
            <div id="activities-area">
            </div>
        </div>
        {% if user_access == "allow" %}

        <div class="content" id="journal-tab">
            <div class="text-right">
                <a href="{% url 'page_create_edit' node.pk %}?course_event_id={{node.pk}}" class="button small"> Add Page </a>
            </div>
            <div class="row all_blogs">
            	{% for each_blog in blog_pages %}
                <div class="blogpage"  style="margin-left:10px;">
                  <h4>
                    <a href="{% url 'page_details' group_id each_blog.pk %}">{{each_blog.name}}</a>
                  </h4>
                  {% if request.user.id == each_blog.created_by or gstaff_access %}

                    <a class="fi-pencil" href="{% url 'page_create_edit' node.pk each_blog.pk %}?course_event_id={{node.pk}}"> Edit </a>
                  {% endif %}
                  <span>
                  Created by {{each_blog.created_by|get_username}} at {{each_blog.created_at}}
                  </span>
                  <div>
                    {{each_blog.html_content|safe}}
                  </div>
                </div>
                <hr/>
              {% empty %}
                <div class="blogpage"  style="margin-left:10px;">
                  <h4><u>
                    <a href="{% url 'page_create_edit' node.pk %}?course_event_id={{node.pk}}">Start writing Pages </a>
                  </u></h4>
                </div>
              {% endfor %}
            </div>
        </div>
        <div class="content" id="gallery-tab">
            <div id="upload_form_div" class="text-right">

                <form class="dropzone" id ="docPost" enctype="multipart/form-data" method="post" action="{% url 'upload_using_save_file' group_id %}">
                    {% csrf_token %}
                    <input type="file" name="doc[]" id="docFile"/>
                    <div class="save_cancel hide">
                      <input type="submit" id="submitpostid" class="tiny button" value="Save"/>
                      <input type="button" id="btnUploadCancel" class="tiny button" value="Cancel"/>
                    </div>
                </form>

            </div>
            <div class="row">
                  {% include "ndf/file_list_tab.html" with resource_type=files_cur detail_urlname="file_detail" filetype="all" res_type_name="" %}
            </div>
        </div>

        <div class="content" id="analytics-tab">
                <div class="row">
                {% get_user_object request.user.id as user_obj %}
                {% check_is_gstaff node.pk user_obj as gstaff_access %}
                {{check_is_gstaff}}
                {% if gstaff_access %}
                    <a href='{% url "group_summary" node.pk %}' target="_blank">{%  trans "Click here to view Group Analytics" %}</a>

                {% else %}
                    <a href='{% url "user_summary" node.pk %}' target="_blank">{%  trans "Click here to view  My Analytics" %}</a>
                {% endif %}
                </div>
        </div>
        {% endif %}

			</div>
    </section>
  
  	</div>
    </div>

{% endblock %}



{% block script %}

  // Cancel/Abort Upload-------------------------------------------------------------
  $("#btnUploadCancel").click(function() {
    $(".save_cancel").addClass("hide");
    $("#docFile").val("");
  });

  
  //Upload file action validation ---------------------------------------------------------------
  $(document).on('change','#docFile',function(){
    $(".save_cancel").removeClass("hide");
    file_mime_type = this.files[0].type;
    if(file_mime_type.indexOf("image/") < 0){
      $(this).val("");
      $(".save_cancel").addClass("hide");
      $('#docFile').val(this.value);
      var message = "{% trans 'Only image files can be uploaded!' %}"
      $("#alertModalLabel").text(message);
      $("#alertModal").addClass("alert");
      $("#alertModal").foundation('reveal', 'open');
    }
  });

  // Update profile photo -----------------------------------------------------------------------
  $("#submitpostid").click(function() {
    if($("#docFile").val() != "") { 
      $("#message").show();
      $(".save_cancel").addClass("hide");
      var message = "{% trans 'Please wait your file is uploading..' %}"
      $("#alertModalLabel").text(message);
      $("#alertModal").addClass("success");
      $("#alertModal").foundation('reveal', 'open');
    }

    else {
      var message = "{% trans 'Please select an image to set it as a profile picture !' %}"
      $("#alertModalLabel").text(message);
      $("#alertModal").addClass("warning");
      $("#alertModal").foundation('reveal', 'open');
      $(".save_cancel").addClass("hide");
      return false;
    }
  });

  $(document).on('click','.save_date',function(){
    date_val = $("#release_date").val()
    css_id_val = $("#css_id").val()
    console.log(date_val)
    console.log(css_id_val)
    $.ajax({
      url: "{% url 'set_release_date_css' node.pk %}",

      data: {
        'date_val':date_val,
        'css_id': css_id_val,
        'csrfmiddlewaretoken': "{{csrf_token}}"
      },

      type: "POST",

      dataType: "json",

      success: function(data){
        console.log(data)
          success_state = data["success"]
          if(success_state){
            location.reload();
          }
      },
    });//end of ajax

  })
  
  $(document).on('click','.enroll-btn',function(){
    //trigger the ajax call to enroll
      $.ajax({
        url: "{% url 'enroll_to_course' node.pk %}",

        data: {
          'csrfmiddlewaretoken': "{{csrf_token}}"
        },

        type: "POST",

        dataType: "json",

        success: function(data){
          success_state = data["success"]
          if(success_state){
            $(".enroll-btn").attr('value', 'ENROLLED')
            $(".enroll-btn").attr("disabled","disabled")
            location.reload();
          }
        },
      });//end of ajax
  })

  $("main.row > aside.columns")
    .removeClass("medium-2")
    .addClass('medium-3').addClass("large-3");

  $("main.row > article.columns")
    .removeClass("medium-10")
    .addClass("medium-9")
    .addClass("large-9")
    .css('float','left');
    $(".jqtree-title-folder").addClass('jqtree-toggler').removeClass('jqtree-title').removeClass('jqtree-title-folder')

{% endblock %}