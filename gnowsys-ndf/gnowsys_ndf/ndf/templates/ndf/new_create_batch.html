{% extends "ndf/base.html" %}
{% load i18n %}
{% load pagination_tags %}
{% load ndf_tags %}
{% block title %} {{title}} {% endblock %}

{% block style %}
  {{block.super}}

  .divider-line { font-size: xx-large; color:lightgray; }
  .line-height-2 { line-height:2; }
  .line-height-2pt5 { line-height:2.5; }
  .fontsize-x-large { font-size: x-large; }

  .margin-0 { margin: 0 !important ;}

  .resource-drawer { 
  border-color: #D3D3D3; border-style: solid; 
  padding: 0 !important; 
  overflow-y: auto;
  }

  .resource-drawer li.bullet-item:hover{
  background-color: #ecf0f1; cursor:pointer;
  }

  .posted-by{ color: #808080; font-size: small; }

  .selected-resource { background-color:lightgray !important ; }

  .resource-type-image {
  height:40px;    
  background-repeat:no-repeat; background-size: 48px 48px


  /* Resetting css-properties for fieldset (also legend, input) */
    /* fieldset (padding-bottom) */ 
    fieldset {
      padding: 1.25rem 1.25rem 1.25rem 1.25rem !important;
    }

    /* legend (background-color) */
    fieldset legend {
      background-color: transparent !important;
    }

    /* input (margin) */
    fieldset input {
      margin: 0 !important;
    }
{% endblock %}

{% block body_content %}
 <form data-abide enctype="multipart/form-data" id="form-batch" method="POST" action="{% url 'save_batch' groupid %}">{% csrf_token %}

  <fieldset id="stud-count">
  <div class="row">
    <div class="small-4 columns end">
      <label>{% trans "Course Type" %}</label>
    </div>
    <div class="small-4 columns end ">
      {% html_widget groupid "" ATs.0 %}
    </div>
  </div>

  <div class="row">
    <div class="small-4 columns end">
      <label>{% trans "Name of Course" %}</label>
    </div>
    <div class="small-4 columns end">
      <select id="acourse_list" name="acourse_list" disabled="disabled">
      </select>
    </div>
  </div>
  <fieldset id="input-fd" class="hide">
    <div class="row">
      <div class="small-2 large-4 columns"><br>
        <b> {% trans "Students Enrolled to this Course: " %} <label id="lblstud_count"> </label></b>
      </div>
    </div>
        <input type="button" class="small button" id="nextbtn" value="Proceed" disabled="disabled" />
  </fieldset>

  </fieldset>

  <fieldset id="make_batch_fs" class="hide">
    <ul class="hide" id="removed_user_ids_ul"></ul>
    <div id="drawer-heading" class="small-5 columns right inline">
      <input type="text" id="drawer_head" name="drawer_head" disabled="disabled">
    </div>
    <br>
  
    <div id="drawer-div"></div>
    <br>
    <div id="batch-btn-div"> </div>
    <div id="batch-container"></div>
  </fieldset>
    <div id="batch-details"></div>
    <input type='button' name='add_btn' id='add_btn' value='Add Batch' class='button round small' onclick = 'add_new_batch()' style='display: none'> 
  <div>
    <input type="submit" class="button" id="save_batch" name="save-batch" value="Save" onclick="save_after_create_batch()" style='display: none'>&nbsp;&nbsp;
<!--     <input type="button" class="button" id="remove_user" name="remove-user" value="Remove" onclick="remove_user_from_batch()" disabled="disabled" style='display: none'>
 -->    <input type="hidden" id="batch_user_list_dict" name="batch_user_list_dict">
    <input type="hidden" id="ac_id" name="ac_id">
  </div>
 </form>
{% endblock %}

{% block script%}
  // <script type="text/javascript">
  //global variables 
  var batch_id=""
  var ac_id=""
  var b_count=0;

  //For selecting Course type
    $("select#nussd_course_type").change(function() {

      var nussd_course_type = $("#nussd_course_type").val();
      $.ajax({
        url: "{% url 'get_announced_courses_with_ctype' group_id %}",

        data: {
          nussd_course_type: nussd_course_type
        },

        type: "GET",

        dataType: "json",

        complete: function () {
          // Enable AC field
          $("select#acourse_list").removeAttr('disabled')
        },
        success: function(data){
          $("select#acourse_list").empty();
          $.each(data,function(i,v){
            se = v["attribute_set"][3]["start_enroll"]
            console.log(se);
            ac_name=v["name"]
            $("select#acourse_list").append(
             $("<option></option>")
              .attr("value",ac_name)
              .text(ac_name)
            );
          });
          $("select#acourse_list").prop("selectedIndex", 0);
        },
      });
    });//end of nussd_course_type.change function

  //For selecting Announced Course type
    $("select#acourse_list").change(function() {
        var acourse_name = $("#acourse_list").val();
        $.ajax({
          url: "{% url 'get_enrolled_students_count' group_id %}",

          data: {
            acourse_name: acourse_name
          },
          type: "GET",
          dataType: "json",
          complete: function () {
          },
          success: function(data){
            $("#input-fd").removeClass("hide")
            if(data["success"]){
              $("#lblstud_count").text(data["stud_count"])
              ac_id = data["acourse_name"]
              $("#nextbtn").removeAttr("disabled")
            }
            else{
              $("#lblstud_count").text(data["stud_count"])
              $("#nextbtn").attr("disabled","disabled")
            }
          },//end of success
        });//end of ajax call
    });//end of acourse_list.change function
  
  //"Next" after inputting #of batches
    $("#nextbtn").click(function(event) {

      $("#nextbtn").off("click")
      $("#input-fd").addClass("hide")
      $("#nussd_course_type").attr("disabled","disabled")
      $("#acourse_list").attr("disabled","disabled")
      batch_name_index = 1;
      $.ajax({
        url: "{% url 'get_students_for_batches' group_id %}",
        data: {
          ac_id:ac_id
        },
        type: "GET",
        dataType: "json",
        success: function(data){
          success_state = data["success"];
          if (data["success"]) {
            drawer_widget = data["drawer_widget"];
            $("#drawer-div").html(drawer_widget);
            if (batch_name_index==1) {
              $("#drawer_head").attr("value","Batch "+batch_name_index);
              batch_name_index += 1;
            }
          }
          else {
           alert("Failed to get drawer")
          }
        },
        complete:function(data){
          $("#make_batch_fs").removeClass("hide")
          if ($("#save_batch").css("display") == "none") {
            $("#save_batch").toggle();
          }
          if ($("#add_btn").css("display") == "none") {
            $("#add_btn").toggle();
          }
        }
      });
    });//end of nextbtn.click()

    batch_user_list_dict = {}

    $(document).on("click","a.edit_batch", function(event){
      edit_batch_name = $(this).attr('id');
      edit_batch_name=edit_batch_name.replace('_',' ')
      console.log(edit_batch_name)
      $("#drawer_head").attr("value",edit_batch_name);
      $("#new_create_batch_drawer2").html("")
      if(batch_user_list_dict.hasOwnProperty(edit_batch_name)){
        for (i=0;i<batch_user_list_dict[edit_batch_name].length;i++){
          console.log(batch_user_list_dict[edit_batch_name][i])
          $("#new_create_batch_drawer2").append(batch_user_list_dict[edit_batch_name][i])
        }
      }
      event.preventDefault();
      return false;
    });

    function add_new_batch(){
      //Fetch the value of "#drawer_head" which will be key for above dict
      batch_name= $("#drawer_head").val()
      arr = [] //Value for above key
      //Add the right drawer resources to this list.
      $("#new_create_batch_drawer2").children("li").each(function(c,v){arr.push(v)});
      //(v.getAttribute("value")
      if(arr.length<=2){
        alert("Batch must have more than 20 members");
        event.preventDefault();
      }
      else{
        if(batch_user_list_dict.hasOwnProperty(batch_name)){
          batch_user_list_dict[batch_name]=[]
          batch_user_list_dict[batch_name] = arr
          $("#"+batch_name.replace(' ','_')).text(batch_name + " -- " + arr.length+" members");
          batch_name_index -=1;
        }
        else{
          batch_user_list_dict[batch_name] = arr
          //Display the Batch details
          batch_det_str="<a href='' class='edit_batch' id='"+batch_name.replace(' ','_')+"'>" + batch_name + "  --  " + arr.length + " members.</a><br>"
          $("#batch-details").append(batch_det_str)
        }

        //Remove these resources from right drawer.
        $("#new_create_batch_drawer2").html("")
        $("#drawer_head").attr("value","Batch "+ batch_name_index);
        batch_name_index+=1;
      }
    };

  //Saving students to batch as batch members
    function save_after_create_batch(){
      for(i in batch_user_list_dict){
        for (j in batch_user_list_dict[i]){
          batch_user_list_dict[i][j]=batch_user_list_dict[i][j].getAttribute("value")
        }
      }
      console.log(batch_user_list_dict)
      
      $("#batch_user_list_dict").val(JSON.stringify(batch_user_list_dict))
      $("#ac_id").val(ac_id)
    }; // end of save_after_create_batch
    //</script>
{% endblock %}