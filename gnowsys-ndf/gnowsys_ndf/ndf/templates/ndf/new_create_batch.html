{% extends "ndf/base.html" %}
{% load i18n %}
{% load pagination_tags %}
{% load ndf_tags %}
{% block title %} {{title}} {% endblock %}

{% block style %}

  .divider-line { font-size: xx-large; color:lightgray; }
  .line-height-2 { line-height:2; }
  .line-height-2pt5 { line-height:2.5; }
  .fontsize-x-large { font-size: x-large; }

  .margin-0 { margin: 0 !important ;}

  .resource-drawer { 
  border-color: #D3D3D3; border-style: solid; 
  padding: 0 !important; 
  overflow-y: auto;
  }

  .resource-drawer li.bullet-item:hover{
  background-color: #ecf0f1; cursor:pointer;
  }

  .posted-by{ color: #808080; font-size: small; }

  .selected-resource { background-color:lightgray !important ; }

  .resource-type-image {
  height:40px;    
  background-repeat:no-repeat; background-size: 48px 48px
  }
{% endblock %}

{% block body_content %}
  <fieldset id="stud-count">
    <div class="small-4 columns">
      <label>{% trans "Course Type" %}</label>
      {% html_widget groupid "" ATs.0 %}
    </div>

    <div class="small-4 columns">
      <label>{% trans "Name of Course" %}</label>
      <select id="acourse_list" name="acourse_list" disabled="disabled">
      </select>
    </div>
  </fieldset>

  
  <div class="row dummy-2-div hide">
    <div class="small-6 columns new-batch">
      {% trans "Batch Name : " %}<input type="text"><hr>
      <div class="batch-user-list-div"></div>
    </div>
    <div class="small-6 columns new-batch">
      {% trans "Batch Name : " %}<input type="text"><hr>
      <div class="batch-user-list-div"></div>
    </div>
  </div>

  <div class="row dummy-1-div hide">
    <div class="small-6 columns end new-batch">
      {% trans "Batch Name : " %}<input type="text"><hr>
      <div class="batch-user-list-div"></div>
    </div>
  </div>


  <fieldset id="input-fd" class="hide">
    <div class="row">
      <div class="small-2 large-4 columns"><br>
        <b> {% trans "Students Enrolled to this Course: " %} <label id="lblstud_count"> </label></b>
      </div>
    </div>
    <br>
    <div class="row">
      <div class="small-3 columns">
        <label>{% trans "Number of batches to create" %}</label>
      </div>
      <div class="left inline"> 
        <input type="text" pattern="\d*" id="txt_batch_count" name="batch_count" placeholder="Enter Number Only" required/>
          <small class="error">{% trans "Entered value should be numbers" %}</small>
      </div>
    </div>
    <div class="row">
      <div class="large-4 columns">
        <input type="button" class="small button" id="nextbtn" value="Next" />
      </div>
    </div>
  </fieldset>

  <div id="drawer-div">
  </div>

  <div id="batch-btn-div"> </div>

  <div id="batch-container"></div>


{% endblock %}

{% block script%}
  // <script type="text/javascript">
  //global variables 
  var batch_id=""
  var ac_id=""

//For selecting Course type
  $("select#nussd_course_type").change(function() {

    var nussd_course_type = $("#nussd_course_type").val();
    $.ajax({
      url: "{% url 'get_announced_courses_with_ctype' group_id %}",

      data: {
        nussd_course_type: nussd_course_type
      },

      type: "GET",

      dataType: "json",

      complete: function () {
        // Enable AC field
        $("select#acourse_list").removeAttr('disabled')
      },

      success: function(data){
        $("select#acourse_list").empty();
        $.each(data, function(i, value) {
          $("select#acourse_list").append(
            $("<option></option>")
              .attr("value", value)
              .text(value)
          );
        });
        $("select#acourse_list").prop("selectedIndex", 0);
      },
    });
  });//end of nussd_course_type.change function

//For selecting Announced Course type
  $("select#acourse_list").change(function() {
      var acourse_name = $("#acourse_list").val();
      $.ajax({
        url: "{% url 'get_enrolled_students_count' group_id %}",

        data: {
          acourse_name: acourse_name
        },
        type: "GET",
        dataType: "json",
        complete: function () {
        },
        success: function(data){
          $("#input-fd").removeClass("hide")
          if(data["success"]){
            $("#lblstud_count").text(data["stud_count"])
            ac_id = data["acourse_name"]
          }
          else{
            $("#lblstud_count").text(data["stud_count"])
          }
        },//end of success
      });//end of ajax call
  });//end of acourse_list.change function

//"Next" after inputting #of batches
  $("#nextbtn").click(function(event) {

    b_count = $("#txt_batch_count").val()
    alert(b_count)
    if (b_count && $.isNumeric(b_count)){
      $("#nextbtn").off("click")
      $("#input-fd").fadeOut();
      $("#stud-count").fadeOut();
      $.ajax({
        url: "{% url 'get_students_for_batches' group_id %}",
        data: {
          ac_id:ac_id
        },
        type: "GET",
        dataType: "json",
        success: function(data){
          success_state = data["success"];
          if (data["success"]) {
            drawer_widget = data["drawer_widget"];
            $("#drawer-div").html(drawer_widget);
          }
          else {
           alert("fail")
          }

        },
      });
      for (i = 1;i<= b_count;i++){
        add_batch_button(i,"batch-btn-div")
        if (i%2==0) {
          $("#batch-container").append($(".row.dummy-2-div.hide"));
          $("#batch-container .row.dummy-2-div.hide").removeClass("hide");
          $("#batch-container .row.dummy-2-div.hide").children(".new-batch").addClass("temp_new_batch");
          $(".temp_new_batch:last").attr("id","new_batch_id"+i).removeClass("temp_new_batch");
          $(".temp_new_batch:first").attr("id","new_batch_id"+(i-1)).removeClass("temp_new_batch");
          console.log(i);
        }
        else if(i==b_count){
          $("#batch-container").append($(".row.dummy-1-div.hide"))
          $("#batch-container .row.dummy-1-div.hide").removeClass().addClass("row 1-batch-div").children(".new-batch").attr("id","new_batch_id"+i)
        }
        
      }
    }
    else{
      alert("Please enter number");
      event.preventDefault();
    }
  });//end of nextbtn.click()


//Create Buttons to create batches
  function add_batch_button(btn_id,div_of_btn){
    var element = document.createElement("input");
    element.type="button"
    element.name = btn_id+"name";
    element.classList.add("button");
    element.classList.add("small");
    element.classList.add("round");
    element.value = "Add to Batch "+btn_id;
    element.id = "batch-"+btn_id;
    //element.setAttribute("onclick","reveal_on_create_batch('batch-"+btn_id+"')");
    var divParent = document.getElementById(div_of_btn);
    divParent.appendChild(element);
  }  // end of add_batch_button()
  
//Saving students to batch as batch members
  function save_after_create_batch(btn_id){
    $("#batch-drawer").foundation('reveal','close')
    widget_for = "new_create_batch_"+btn_id
    class_value = ".node_id." + widget_for + "_values"
    right_drawer_len = $(class_value).size();
    batch_name=$("#batch_ip_id_"+btn_id).val()
    $("#"+btn_id).removeAttr("onclick")
    $("#drawer-div").empty()
    //$("#"+btn_id).removeAttr("data-reveal-id")
    alert(ac_id)
    var user_list = [];
    
    if (right_drawer_len > 0) {
      $(class_value).each(function (){
        resource_id = $(this).val()
        user_list.push(resource_id);
      });
      $.ajax({
        url: "{% url 'save_students_for_batches' group_id %}",
        type: "POST",
        dataType: "json",
        data: {
          user_list:JSON.stringify(user_list),
          batch_name:batch_name,
          ac_id:ac_id,
          csrfmiddlewaretoken:"{{csrf_token}}"
        },
        success: function(data){
            alert("success1")
            batch_id = data
        },
        complete: function(){
          alert("complete")
            batch_btn = document.getElementById(btn_id)
            batch_btn.value=batch_name
        }
      });
    }
    else{
      alert("Please select Students")
      event.preventDefault();
    }
  }; // end of save_after_create_batch

//Saving batch after edit
  function save_after_edit_batch(btn_id){
      alert("edited");
  }



  //</script>
{% endblock %}