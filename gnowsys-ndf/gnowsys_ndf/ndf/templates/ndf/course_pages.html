{% load i18n %}
{% load ndf_tags %}
{% block head %}
    
    <style type="text/css">
    .right-btn, .left-btn{
        /*float: left;*/
        /*margin-left: 1rem;*/
        width: 40%;
        font-size: 0.85em !important;
        margin-top: 0.1rem !important;
        text-align: center;
    }
</style>
{% endblock %}

<!-- Handles Activity page detail and listing -->
{% if activity_node and not editor_view %}
    <div class="activity-detail-page">
        <div class="row">
            <div class="small-1 columns icon-widget" style="margin-top: 5.6px;">
            <a href="{% url 'course_pages' group_id %}"><i class="fa fa-chevron-left large" aria-hidden="true"></i></a>
            </div>

            <div class="small-8 columns">
                <h4 class="page-name">{{activity_node.name}}</h4>
            </div>
            
            {% if activity_node.created_by == request.user.id or is_gstaff %}
            <div class="small-3 columns right">
                <span data-dropdown="activity-page-settings-drop" aria-controls="activity-page-settings-drop" aria-expanded="false" class="orange-button right">
                    Actions <i class="fa fa-chevron-down"></i>
                </span>
                <ul id="activity-page-settings-drop" class="f-dropdown" data-dropdown-content aria-hidden="true" tabindex="-1">
            
                <li><a href="{% url 'edit_course_page' group_id activity_node.pk %}">Edit</a></li>
                <li><a title="Edit Content" class="edit_res_unit">{% trans " Edit Content" %}</a></li>
                <li><a title="Edit Interaction Settings" class="edit-interaction">{% trans "Interaction Settings" %}</a></li>
                <li><a href="{% url 'all_translations' group_id activity_node.pk %}" target="_blank">Alternate Language</a></li>
                </ul>

            </div>
            {% endif %}
        </div>
        <div class="row">
            <div class="small-10 columns left">
                 {% if activity_node.tags %}
                    {% for tag in activity_node.tags %}
                            <small><label class="tag-ele" style="margin-top: 13px;">
                        <a href="{% url 'tag_info' group_id tag %}">{{tag}} </a></label></small>
                    {% endfor %} 
                {% else %}
                    <i><small><label>{% trans "No tags defined yet!" %}</label></small></i>
                {% endif %}   
            </div>
        </div>

        <div class="row activity-detail-content">
            {% include "ndf/node_ajax_content.html" with node=activity_node %}
        </div>
    </div>


{% else %}
    
        <div class="activity-sheet-actions">
            <div class="row">
            {% if all_pages.count %}
            <button type="button" class="orange-button delete-activity right" title="Click on the checkbox on the files below to Delete"><i class="fa fa-trash"></i> Delete</button>
            {% endif %}
            {% if user.is_authenticated %}
            <a class="right orange-button-template" href="{% url 'create_course_page' group_id %}"><i class="fi-plus"></i> Add</a>
            {% endif %}


            </div>
        </div>
    


    <div id="page_listing">
    
    
    
        <div class="row">
            {% for each in all_pages %}
                <a class="view-page" data-page-id="{{each.pk}}" data-node-name="{{each.name}}" title="{{each.name}}" href="{% url 'view_course_page' group_id each.pk %}">
                    <div class="small-12 medium-6 large-3 columns">
                        <div class="asset_tile">
                            <div class="asset_preview">
                                {% if each.if_file.mid.relurl and 'video' not in each.if_file.mime_type %}
                                <img src="{{MEDIA_URL}}{{each.if_file.mid.relurl}}">
                                {% elif 'video' not in each.if_file.mime_type and each.if_file.thumbnail.relurl %}
                                <img src="{{MEDIA_URL}}{{each.if_file.thumbnail.relurl}}">
                                {% else %}
                                <img src="/static/ndf/images/asset_thumbnail.png">
                                {% endif %}
                            </div>
                            <div class="asset_text">
                                <div class="asset_title" title="{{each.name}}">{{each.name|truncatechars:25}}</div>
                                    {% if user.is_authenticated  and not group_object.edit_policy == "NON_EDITABLE"  or gstaff_access %}
                                    <input type="checkbox" class="activitynode" name="activitynode" value="{{each.pk}}" style="margin:0; float:right;" class="asset_content_checkbox">
                                    {% endif %}
                                <div class="asset_desc">{{each.content|safe|striptags|truncatechars:25}}</div>
                            </div>
                        </div>
                    </div>
                </a>
            {% endfor %}
        </div>
    </div>



{% endif %}

<script type="text/javascript">
    $(".delete-activity").click(function(){
        var checked = $('.activitynode:checked').length;
        if (checked > 0){

            if (confirm("Do you want to delete selected files?.") == true) {
                coll_arr = []
                $('.activitynode:checked').each(function() {
                    coll_arr.push($(this).val());
                });

                $.ajax({
                          type: "POST",
                          data:{
                                'csrfmiddlewaretoken': "{{csrf_token}}",
                                'delete_files_list' : coll_arr,
                            },
                          url: "{% url 'delete_activity_page' group_id %}",
                          datatype: "json",
                          success: function(data) {
                            console.log(data)
                            if (data=="success"){
                                $.each(coll_arr, function(ind,activity_id){
                                    $("a[data-page-id='"+activity_id+"']").addClass('hide')
                                })
                                // location.reload()
                            }
                            else{
                                alert("Something went wrong. Please try again later.")
                            }
                        }
                    });

                }
        }
        else{
            alert("Choose atleast one Activity");
        }


    });

        $( ".edit-interaction" ).click(function(event) {
            $.ajax({
                  type: "POST",
                  data:{
                        'csrfmiddlewaretoken': "{{csrf_token}}",
                        "node_id":'{{activity_node.pk}}',
                    },
                  url: "{% url 'get_interaction_widget' group_id  %}",
                  datatype: "html",
                  success: function(data) {
                  $('#addAsset').foundation('reveal', 'open');
                  $('#addAsset').html(data);
                }
            });
        });
    
        $(document).on('click',".edit_res_unit",function(){
        $.ajax({
          url: "{% url 'inline_edit_res' group_id %}",

          type: "GET",

          data: {
            "node_id": "{{activity_node.pk}}",
            "node_content": $(".activity-detail-content .content_val").html()
          },
          dataType: "html",

          success: function(data){
            $(".activity-detail-content").html(data);
            $(".edit_res_unit").text("Save Content")
                          .addClass("save_res_unit")
                          .removeClass("edit_res_unit")
          },
        });//end of ajax
    });

    $(document).on('click',".save_res_unit",function(){
        var content_val = CKEDITOR.instances['ckeditor_textarea'].getData();
        // console.log(content_val)
        $.ajax({
          url: "{% url 'inline_edit_res' group_id %}",

          data: {
            "content_val": content_val,
            "node_id": "{{activity_node.pk}}",
            "custom_redirect": "view_course_page",
            'csrfmiddlewaretoken': "{{csrf_token}}"
          },

          type: "POST",

          dataType: "html",

          success: function(data){
            $(".node_details").html(data);
            $(".save_res_unit").text("Edit Content")
                          .addClass("edit_res_unit")
                          .removeClass("save_res_unit")
            location.reload()
          },
        });//end of ajax

    });


</script>
