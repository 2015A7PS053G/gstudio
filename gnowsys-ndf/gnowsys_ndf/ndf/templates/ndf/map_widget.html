<!DOCTYPE html>
<html>
<head>

	<!-- <title>Maps Widget</title> -->

	<meta charset="utf-8">
	<meta content="width=device-width, initial-scale=1.0" name="viewport">

	<!-- JS Links -->
	<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
	<!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script> -->
	<!-- <script src="https://raw.githubusercontent.com/stefanocudini/leaflet-search/master/src/leaflet-search.js" type="text/javascript" ></script> -->

	<!-- CSS Links -->
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
	<!-- <link rel="stylesheet" type="text/css" href="foundation.css" /> -->
	<!-- <link rel="stylesheet" type="text/css" href="https://raw.githubusercontent.com/stefanocudini/leaflet-search/master/src/leaflet-search.css"> -->

	<style type="text/css">
		
		#map { height: 100%; width: 100%; }

		.leaflet-popup-content {	min-width:145px; max-width: auto;	}

		.popup-add-content-button { background-color: #199369; color: #FFFFFF; display: block; float: left; padding: 1px 2px;	}

		.popup-delete-content-button { background-color: #F04124; color: #FFFFFF; display: inline-block; float: right; padding: 1px 2px;	}

		.popup-content {	padding: 0.25;	margin-bottom: 0.5em; }
		
		.popup-content:focus {	
								background-color: #FFFFE0;
							    border-color: buttonface;
							    border-style: dashed;
							    margin-bottom: 0.5em;
							    padding: 0.25em;
							}		

	</style>

</head>

<body>

	<div id="map" data-mode="{{mode}}"><input type="hidden" data-map-markers="{{ node.location }}" value="" name="map-geojson-data"/></div>

	<div style="display:none;">
		<div class="popup-html">
			<div class="popup-content" contenteditable="true"></div>
			<div class="row">
				<div class="small-5 popup-add-content-button text-center"><i class="fi-page-edit">&nbsp; edit</i></div>			
				<div class="small-5 popup-delete-content-button text-center"><i class="fi-trash">&nbsp; marker</i></div>			
			</div>
		</div>
	</div>
	
	<script type="text/javascript">

	 	// We’ll add a tile layer to add to our map, in this case it’s a OSM tile layer.
	 	// Creating a tile layer usually involves setting the URL template for the tile images
	 	var osmUrl 	  = 'http://{s}.tile.osm.org/{z}/{x}/{y}.png',
	 	osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
	 	osm 	  = L.tileLayer(osmUrl, {maxZoom: 18, attribution: osmAttrib});
	 	
	 	// initialize the map on the "map" div with a given center and zoom
	 	var map = L.map('map').setView([25.92,79.84], 5).addLayer(osm);

	 	var initialPopContent = "Add description.. <i>(optional)</i>";

	 	// map.addControl( new L.Control.Search({layer: searchLayer}) );

	 	mapdata = $("input:hidden[name=map-geojson-data]").attr("data-map-markers");
	 	
	 	markerGeoJSON = [];
	 	popupBasicHtml = $(".popup-html").html()

	 	if( mapdata.length > 0 )
	 	{
	 		// Adding mapdata on map
		 	// L.geoJson(mapdata, {onEachFeature: function (feature, layer) {
		 	// 	// layer.bindPopup("feature.properties.description");
		 	// }}).addTo(map);

			mapdata = mapdata.replace(/'/gm, '"');
	 		mapdata = mapdata.replace(/u"/gm, '"');
	 		mapdata = JSON.parse(mapdata);

			tempArr = []	// to catch newly created markers
			
			L.geoJson(mapdata, {
			    
			    pointToLayer: function (feature, latlng) {

					var description = feature.properties.description,
						tempPopupContent;

					if(description)
					{
						tempPopupContent = popupBasicHtml.replace('<div class="popup-content" contenteditable="true"></div>','<div class="popup-content" contenteditable="true">'+description+'</div>');
					}
					else
					{
						tempPopupContent = popupBasicHtml.replace('<div class="popup-content" contenteditable="true"></div>','<div class="popup-content" contenteditable="true">'+ initialPopContent +'</div>');
					}

			    	{% if mode == "edit" %}
			        	var marker = L.marker(latlng, {
							draggable:true,
							title:"Resource location",
							alt:"Resource Location",
							riseOnHover:true
						}).bindPopup(tempPopupContent);

			        	marker.on("popupopen", activateMarker );
						marker.on("dragend", dragend);

			        {% else %}
			        	var marker = L.marker(latlng, {
							title:"Resource location",
							alt:"Resource Location",
							riseOnHover:true
						}).bindPopup(feature.properties.description);

			       	{% endif %}

						tempArr.push(marker);
						
					return marker;
					
			    }
			}).addTo(map);
			
	        // Adding mapdata values in markerGeoJSON.
	        $.each(tempArr, function(i, val){ 

	        	var addLeafletID = tempArr[i].toGeoJSON();
	        	
	        	// console.log(tempArr[i].feature.properties.description);
	        	
	        	$(addLeafletID).attr("properties", {"id": tempArr[i]._leaflet_id, "description":tempArr[i].feature.properties.description});
	        	markerGeoJSON.push(JSON.stringify(addLeafletID));

	        })
	        updateHiddenTagContent();

	 	}

	 	

	 	function updateHiddenTagContent()
	 	{
	 		$('input:hidden[name=map-geojson-data]').attr("data-map-markers", markerGeoJSON)
			$('input:hidden[name=map-geojson-data]').attr("value", markerGeoJSON)
	 	}
	 	

		{% if mode == "edit" %}
			map.on('click', onMapClick );

		// Script for adding marker on map click
		function onMapClick(e) {

			var tempPopupContent = popupBasicHtml.replace('<div class="popup-content" contenteditable="true"></div>','<div class="popup-content" contenteditable="true">'+ initialPopContent +'</div>');

			var marker = L.marker(e.latlng, {
				draggable:true,
				title:"Resource location",
				alt:"Resource Location",
				riseOnHover:true
			}).addTo(map)
				.bindPopup(tempPopupContent);
				// .openPopup();
			
			marker.on("popupopen", activateMarker );
			marker.on("dragend", dragend);

			var addLeafletID = marker.toGeoJSON();
			$(addLeafletID).attr("properties", {"id": marker._leaflet_id});
			
			markerGeoJSON.push(JSON.stringify(addLeafletID));

			$('input:hidden[name=map-geojson-data]').attr("data-map-markers", markerGeoJSON)
			$('input:hidden[name=map-geojson-data]').attr("value", markerGeoJSON)
			
		}

		// Update marker on changing it's position
		function dragend(ev){
			
			var changedPos = ev.target.getLatLng();
			
           	this.setLatLng(changedPos).update();	// Update the marker position

           	var lID = this._leaflet_id;		// Getting Leaflet ID of this marker

           	var tempMarkerGeoJSON = this.toGeoJSON();

			var description = tempMarkerGeoJSON.properties.description;

			if(! description)
			{
				$.each(markerGeoJSON, function(i, val) {
				            	
					            		var getID = $.parseJSON(val).properties.id,
					            			getDescription = $.parseJSON(val).properties.description; 
				
					            		if(getID == lID) { description = getDescription?getDescription:"";  }  
					           		})
			}

			if(description)
			{					
				$(".popup-content:visible").text(description);
			}

			// tempMarkerGeoJSON.properties.description = $(this).parent().parent().find(".popup-content:visible").text();					

			tempMarkerGeoJSON.properties.id = lID;	
			
					
					var updatedGeoJSON = JSON.stringify(tempMarkerGeoJSON);
			
            		$.each(markerGeoJSON, function(i, val) {
            	
	            		var getID = $.parseJSON(val).properties.id; 
	            		if(getID == lID) { markerGeoJSON[i] = updatedGeoJSON; }  
            		})

            		updateHiddenTagContent();

   //         	var addLeafletID = this.toGeoJSON();
			// $(addLeafletID).attr("properties", {"id": lID});

   //         	updatedGeoJSON = JSON.stringify(addLeafletID);

   //         	$.each(markerGeoJSON, function(i, val) {
            	
   //         		var getID = $.parseJSON(val).properties.id; 
   //         		if(getID == lID) { markerGeoJSON[i] = updatedGeoJSON; }  
   //         	})

           	// this.setPopupContent(changedPos.toString()).openPopup();	// Updating popup Msg
           	// $('input:hidden[name=map-geojson-data]').attr("data-map-markers", markerGeoJSON);
           	// $('input:hidden[name=map-geojson-data]').attr("data-map-markers", markerGeoJSON)
           	// $('input:hidden[name=map-geojson-data]').attr("value", markerGeoJSON)
        }//);


		function activateMarker(){

			var tempMarker = this;
			// tempMarker._popup._content			
			var tempMarkerGeoJSON = this.toGeoJSON();
			// console.log(JSON.stringify(tempMarkerGeoJSON));
			var lID = tempMarker._leaflet_id;		// Getting Leaflet ID of this marker

			var description = tempMarkerGeoJSON.properties.description;

			if(! description)
			{
				$.each(markerGeoJSON, function(i, val) {
				            	
					            		var getID = $.parseJSON(val).properties.id,
					            			getDescription = $.parseJSON(val).properties.description; 
				
					            		if(getID == lID) { description = getDescription?getDescription:"";  }  
					           		})
			}
			 			
			if(description)
			{					
				$(".popup-content:visible").text(description);
			}
			
			// To remove marker on click of delete
			$(".popup-delete-content-button:visible").click(function(){

				$.each(markerGeoJSON, function(i, val) {

	            		getID = JSON.parse(val).properties.id; 

	            		if(getID == lID) { markerGeoJSON.splice(i,1);	return false; }  
            		})

				map.removeLayer(tempMarker);

				updateHiddenTagContent();
			});

			
			$(".popup-content").on("blur", function(){
			
				if($(this).html() != initialPopContent )
				{
					$(this).siblings().find("i.fi-page-edit:visible").attr("class", "fi-save").text(" save");
					// saveEditBtn = $(this).siblings().find("div.popup-add-content-button");
				}
			});
			
			// To add content on click of add content
			$(".popup-add-content-button:visible").click(function(){

				if($(this).children("i").hasClass("fi-page-edit"))
				{						
					$(this).parent().parent().find(".popup-content").focus();	
				}
				else if($(this).children("i").hasClass("fi-save"))
				{
					$(this).find("i.fi-save:visible").attr("class", "fi-page-edit").text(" edit");

					tempMarkerGeoJSON.properties.description = $(this).parent().parent().find(".popup-content:visible").text();					

					if(! tempMarkerGeoJSON.properties.id)
					{
						tempMarkerGeoJSON.properties.id = lID;	
					}
					
					var updatedGeoJSON = JSON.stringify(tempMarkerGeoJSON);
					// console.log(updatedGeoJSON);
            		$.each(markerGeoJSON, function(i, val) {
            	
	            		var getID = $.parseJSON(val).properties.id; 
	            		if(getID == lID) { markerGeoJSON[i] = updatedGeoJSON; }  
            		})

            		updateHiddenTagContent();
				}
			});			

		}



		{% endif %}

		// function removeMarker(markerEl){
		// 	alert($(markerEl).html());
		// 	map.removeLayer(markerEl);
		// }

		// function addPump(){
		// 	var pump = L.marker(cords,{icon: truckPump}).addTo(map).bindPopup($('<a href="#" class="speciallink">Remove ME</a>').click(function() {
		// 		map.removeLayer(pump);
		// 	})[0]);
		// }

		// map.on('click', onMapClick );
		// map.invalidateSize();
	</script>
	
</body>
</html>



<!-- 
[{'geometry': {'type': 'Point', 'coordinates': [86.5283203125, 23.82555130688476]}, 'type': 'Feature', 'properties': {'id': 27}}, {'geometry': {'type': 'Point', 'coordinates': [85.20996093749999, 23.301901124188877]}, 'type': 'Feature', 'properties': {'id': 34}}]

=======================================================

http://leafletjs.com/reference.html#geojson
http://leafletjs.com/examples/geojson.html
https://paulcrickard.wordpress.com/tag/geojson/
https://www.mapbox.com/blog/open-web-geojson/

var geojsonFeature = {
    "type": "Feature",
    "properties": {
        "name": "Coors Field",
        "amenity": "Baseball Stadium",
        "popupContent": "This is where the Rockies play!"
    },
    "geometry": {
        "type": "Point",
        "coordinates": [-104.99404, 39.75621]
    }
};


Alternatively, we could create an empty GeoJSON layer and assign it to a variable so that we can add more features to it later.

var myLayer = L.geoJson().addTo(map);
myLayer.addData(geojsonFeature);


map.eachLayer(function(e){ console.log(e._leaflet_id); })

map.eachLayer(function(layer){
  if(layer.toGeoJSON){
    console.log(layer.toGeoJSON())
  }
});

// to modify geoJSON object aaa
$(aaa).attr("properties", '{"id":23}')


for search in OSM : https://github.com/twain47/Nominatim

=======================================================
 -->