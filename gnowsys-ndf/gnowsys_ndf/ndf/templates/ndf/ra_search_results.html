{% extends "ndf/base.html" %}
<script type = "text/javascript" src = "/static/ndf/js/jquery2.js">
</script>
<!--<script src="//code.jquery.com/ui/1.11.0/jquery-ui.js"></script>-->
{% block body_content %}
<form name="search_form" action="{% url 'get_relation_type' groupid %}" method="GET" action="">
	{% csrf_token %}
	Enter the value to be searched:
	<input type="text" name="search_text" id="search_text" list="datalist1" required>
	<input type="submit" value="Submit"></input>	
	<div id="suggestions" >
	</div>

	<div id="results">
	</div>

	<div id="pages">
	</div>
</form>

<script type="text/javascript">
	var GSystem_name = [];
	$("#search_text").keyup(function(e){
		//console.log(e.which);
		var searchKey = $("#search_text").val();
		words = searchKey.split(' ');
		cur_word = words[words.length-1];
		already_typed = "";
		pref = "";

		if (words.length != 1) {
			//console.log('not zero'+words);
			for (i=0;i<words.length-1;i++) {
				already_typed += ' ' + words[i];
			}
			pref = already_typed;
		}
		else {
			//console.log('zero');
			already_typed = searchKey;
			pref = "";
		}

		if (already_typed != "" && cur_word != "") {
			$.ajax({
				url:"{% url 'get_relations_for_autoSuggest' groupid %}",
				type:"GET",
				dataType:"JSON",
				data:{
					sVal:cur_word,
					prefix:pref
				},
				success:function(data){
					//var str = "<select size='5' id='autocomplete' onChange='changed_val()'>";
					var str = "<datalist style='color:#fff' id='datalist1'>";
					for(i=0;i<data.length;i++){
						str += "<option value='" + data[i] + "'>"; 
					}
					str += "</datalist>";			
					console.log(data);
					//dataVals = ["one", "two", "three"];
					$("#suggestions").html(str);
					//$( "#search_text" ).autocomplete({
					//	source: data
					//});
				},
				failure:function(data){
					alert('GOT AN ERROR');
				}			
			});
		}
		else {
			$("#suggestions").html("");
		}
		return false;
	});

	function changed_val() {
		$("#search_text").val($("#autocomplete").val().trim());
		console.log("click 2");
	}

</script>

<script type="text/javascript">
	var html_div = [];
	var group = "{{ groupid }}";
	var base_url = location.host+"/"+group+"/";
	var page_no = 0;
	var results_per_page = 10;
	var results_in_current_page = 0;
	var cur_page = 0;

	$(document).ready(function() {

		sData = "{{ search_results }}";
		sData = sData.replace(/&quot;/g, '"'); 
		sData = jQuery.parseJSON(sData);
		parse_data(sData);
		
		function parse_data(sData) {

			var a = sData.length;

			html_div[cur_page] = "<ul class='small-block-grid-1 medium-block-grid-3 large-block-grid-4'>";			
			for (i=0; i<a; i++) {
				type = alterType(sData[i].link);
				GSystem_link = assignLink(type, sData[i].link.toLowerCase(), sData[i]._id);

				html_div[cur_page] += generateCard(sData[i].name, type, sData[i].created_by, sData[i].last_update, GSystem_link);

				results_in_current_page += 1;
				if (results_in_current_page >= results_per_page) {
					html_div[cur_page] += "</ul>";
					cur_page += 1;
					results_in_current_page = 0;
					html_div[cur_page] = "<ul class='small-block-grid-1 medium-block-grid-3 large-block-grid-4'>";
				}										
			}
			$("#results").html(html_div[page_no]);

			pages = "<h6>Pages:</h6><hr>";
			pages += "<ul style='float:left; list-style-type:none;'>";
			for (i=0; i < cur_page+1; i++) {
				pages+= "<li onClick='changePage(" + i + ")' style='cursor:pointer'>" + (i+1) + "</li>";
			}
			pages+="</ul>";
			$("#pages").html(pages);
		}

	});

	function changePage(p) {
		$("#results").html(html_div[p]);
	}

	function alterType(type) {
		type = type.toLowerCase();
		if (type=="quiz/details") {
			type = "Quiz / Quiz Item";
		}
		else if (type=="forum/thread") {
			type = "Thread";
		}
		return type;
	}

	function assignLink(type, link_url, gs_id) {
		var group = "{{ groupid }}";
		var base_url = location.host+"/"+group+"/";
		GSystem_link = "";
		//tp://" + base_url + link_tp://" + base_url + link_
		if (type != "none") {
			GSystem_link = "http://" + base_url + link_url + "/" + gs_id;
		}
		else {
			GSystem_link = "http://" + base_url + "search/node_info2/" + gs_id;
		}

		return GSystem_link;
	}

</script>

<script type="text/javascript">
function generateCard(name, GSystem_type, created_by, last_modified, GSystem_link) {
	var card_html = "";

	card_html += '<li class="card">';
		card_html += '<div class="file">';
	  
	        card_html +=  '<header>';
	            card_html += '<div class="label-list">';
	            
	            card_html += '</div>';
	      
	            card_html += '<h4>'+name;
		            card_html += '<div>';
			            card_html += '<small class="subheader">';
			            	card_html += GSystem_type + ", last modified: " + last_modified;
			            	card_html += '<br>';
			            	card_html += 'by <span data-gnow="" class="user" href="#"><i style="background-color:" class="fi-torso"></i>' + created_by + '</span>'; 
			            card_html += '</small>';
		            card_html += '</div>';
	            card_html += '</h4>';
	        card_html += '</header>';

	        card_html += '<a href=' + GSystem_link + ' class="button expand" target="_blank">View details</a>';
	  
        card_html += '</div>';
      card_html += '</li>';

    return card_html;  
}
</script>

{% endblock %}