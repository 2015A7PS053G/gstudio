{% load ndf_tags %}
{% load i18n %}
{% get_group_name groupid as group_name_tag %}
{% get_user_quiz_resp node request.user as user_sub_ans %}

<style type="text/css">
	.quiz_qtn{
		margin-left:20px !important;
		font-size: 20px;
	}
	.question_edit{
		margin-left: 20px !important;
	}

	input[type=checkbox], input[type=radio]{
	    margin-right: 10px;
	    width: 15px;
		height: 15px;
	}

	.chk_ans_lbl, .rad_ans_lbl{
		font-size: 22px;
		margin-left: 5px;
	}

	.fi-check{
		color: green;
	}

	.fi-x{
		color: red;
	}
</style>

<div class="row">

	<fieldset>

	    <legend >
	    	<span>Question</span>
			{% check_is_gstaff groupid request.user as is_gstaff %}
			{% if is_gstaff %}
		    	<a href="{% url 'quiz_item_edit' group_id node.pk %}?return_url={{ request.META.HTTP_REFERER }}" class="right question_edit" target="_blank" >Edit</a>
		    {% endif %}
	    </legend>

		<div class="row">
			<div class="quiz_qtn">
				<b>{{node.content_org}}</b>
				<div class="quiz_qtn">
					{% if node.quiz_type == "Single-Choice" %}
						{% for each_opt in node.options %}
							<input type="radio" name="quiz_ans"  value="{{each_opt}}"
							{% if each_opt in node.correct_answer %}
								class="choice" id="{{each_opt}}">{{each_opt}}<span class='fi-check hide chk_ans_lbl'></span>
							{% else %}
								class="choice" id="{{each_opt}}">{{each_opt}}<span class='fi-x hide chk_ans_lbl'></span>
							{% endif %}
							<br/>
						{% endfor %}
						{% comment %}
						<div class="row">
							{% if node.quizitem_check_answer %}
								<input type="button" value="Check" class="button tiny check-ans radius check-btn">
							{% endif %}
							{% if node.quizitem_show_correct_ans %}
								<input type="button" value="Show Answer" class="button tiny radius show-ans-btn hide">
							{% endif %}
						</div>
						{% endcomment %}
					{% elif node.quiz_type == "Multiple-Choice" %}
						{% for each_opt in node.options %}
							<input type="checkbox" name="quiz_ans" value="{{each_opt}}"
							{% if each_opt in node.correct_answer %}
								class="choice" id="{{each_opt}}">{{each_opt}}<span class='fi-check hide chk_ans_lbl'></span>
							{% else %}
								class="choice"  id="{{each_opt}}">{{each_opt}}<span class='fi-x hide chk_ans_lbl'></span>
							{% endif %}
							<br/>
						{% endfor %}
					{% elif node.quiz_type == "Short-Response" %}
						<textarea rows="4" cols="50" name="quiz_ans" class="choice" placeholder="Enter answer here" class="short_ans_txt"></textarea>
						<!-- <input type="button" value="Submit" class="button tiny radius short-ans_chk"> -->
					{% endif %}
					<div class="row">
						{% if node.quizitem_check_answer %}
							<input type="button" value="Check" class="button tiny check-ans radius check-btn">
						{% endif %}
						{% if node.quizitem_show_correct_ans %}
							<input type="button" value="Show Answer" class="button tiny radius show-ans-btn hide">
						{% endif %}
						<input type="button" value="Submit" class="tiny button radius submit-btn">
					</div>

				</div>
			</div>
		</div>
	</fieldset>
</div>

<script type="text/javascript">
	user_sub_ans_list = {{user_sub_ans|jsonify|safe}}

	$(document).ready(function() {
		display_sub_ans()
	})

	$(".check-btn").click(function(){
		{% if node.quiz_type == "Multiple-Choice" %}
			var selected_ans = $('input:checkbox:checked')
		{% elif node.quiz_type == "Single-Choice" %}
			var selected_ans = $('input:radio:checked')
		{% endif %}

		if($(this).val() == "Check"){
			if( selected_ans.length > 0){
				all_ans = user_ans()
				$(".check-btn").val("Clear")
				$(".show-ans-btn").removeClass("hide")
				save_user_action("check",all_ans)
			}
			else{
				alert("Please select an answer")
			}
		}
		else if ($(this).val() == "Clear"){
			hide_options();
			display_sub_ans()
		}
	})

	function display_sub_ans(){
		user_ans_list = user_sub_ans_list
		$.each(user_ans_list,function(ind,each_opt_val){
			$("#"+each_opt_val).prop("checked", true)
		})
	}

	function user_ans(){
		list_name = []
		$.each($('.choice:checked'), function(a,b){
			list_name.push(b.id)
			n = b.nextSibling.nextSibling
			n.classList.remove("hide")
		})
		return list_name;

	}

	function hide_options(){
		{% if node.quiz_type == "Multiple-Choice" %}
			$('input:checkbox').removeAttr('checked')
			var selected_ans = $('input:checkbox:checked')
		{% elif node.quiz_type == "Single-Choice" %}
			$('input:radio').removeAttr('checked')
			var selected_ans = $('input:radio:checked')
		{% endif %}
		$(".chk_ans_lbl").addClass("hide")
		$(".check-btn").val("Check")
		$(".show-ans-btn").addClass("hide")
	}

	$('input:radio').change(function() {
		if($(".check-btn").val() == "Clear"){
			hide_options();
			$(this).prop("checked", true)
		}
	})

	$('input:checkbox').change(function() {
		if($(".check-btn").val() == "Clear"){
			hide_options();
			$(this).prop("checked", true)
		}
	})

	$(".show-ans-btn").click(function(){
		$(".fi-check").removeClass("hide")
	})

	$(".submit-btn").click(function(){
		{% if node.quiz_type == "Short-Response" %}
			var user_given_ans = $(".choice").val()
			user_given_ans = [user_given_ans]
		{% else %}
			var user_given_ans = user_ans()
		{% endif %}
		save_user_action("submit",user_given_ans)
	})

	function save_user_action(user_action, user_given_ans){
        $.ajax({
          url: "{% url 'save_quizitem_answer' group_id %}",

          data: {
            node: "{{node.pk}}",
            user_action: user_action,
            user_given_ans: user_given_ans,
            'csrfmiddlewaretoken': "{{csrf_token}}"
          },

          type: "POST",

          dataType: "json",

          success: function(data){
          	user_sub_ans_list = user_given_ans
          },
        });//end of ajax

	}

</script>